generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               Int                     @id @default(autoincrement())
  username         String                  @unique
  password         String
  name             String
  role             String                  @default("USER")
  telegramId       String?                 @unique
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  productionStaff  ProductionStaff?
  // Expeditor link (optional 1:1)
  expeditor        Expeditor?
  // Production Module v2 relations
  createdMmls      ProductionMml[]         @relation("MmlCreator")
  productionRuns   ProductionRun[]         @relation("RunUser")
  // Purchase Module relations
  purchases        Purchase[]              @relation("PurchaseCreator")
  // Warehouse Module relations
  warehouses       Warehouse[]             @relation("WarehouseResponsible")
  // Production-Purchase Integration
  productionDocs   ProductionDoc[]         @relation("ProductionDocCreator")
  productionInputs ProductionInput[]       @relation("ProductionInputLoader")
  cuttingLines     ProductionCuttingLine[] @relation("CuttingLineCreator")
}

model District {
  id        Int        @id @default(autoincrement())
  code      String     @unique
  name      String
  customers Customer[]
}

model Manager {
  id        Int        @id @default(autoincrement())
  code      String     @unique
  name      String
  phone     String?
  customers Customer[]
}

model Product {
  id                       Int                       @id @default(autoincrement())
  code                     String                    @unique
  name                     String // Полное название
  altName                  String? // Альтернативное название
  priceListName            String? // Название прайс-листа (было shortNameMorning)
  category                 String?
  status                   String                    @default("active")
  coefficient              Float                     @default(1.0)
  lossNorm                 Float                     @default(0.0)
  participatesInProduction Boolean                   @default(false) // Участие в производстве - если true, товар подгружается в производство при закупке
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  orderItems               OrderItem[]
  stock                    Stock?
  stockTransactions        StockTransaction[]
  suppliers                SupplierProduct[]
  summaryJournalEntries    SummaryOrderJournal[]
  productionItems          ProductionItem[]
  purchasePriceItems       PurchasePriceItem[]
  salesPriceItems          SalesPriceItem[]
  // Production Module v2 relations
  productionMmls           ProductionMml[] // MML для этого товара
  mmlNodes                 ProductionMmlNode[]       @relation("MmlNodeProduct") // Узлы MML где этот товар
  productionRuns           ProductionRun[]           @relation("ProductRuns") // Выработки этого товара
  runValueSnapshots        ProductionRunValue[]      @relation("RunValueSnapshot") // Снимки значений
  // Purchase Module relations
  purchaseItemsRel         PurchaseItem[]            @relation("PurchaseItemProduct") // Строки закупок с этим товаром
  // SVOD Module relations
  svodLines                SvodLine[]
  svodSupplierValues       SvodSupplierValue[]
  // Production-Purchase Integration
  productionInputs         ProductionInput[]         @relation("ProductionInputProduct")
  productionOutputs        ProductionOutput[]        @relation("ProductionOutputProduct")
  cuttingLineOutputs       ProductionCuttingLine[]   @relation("CuttingLineOutput")
  // Customer-specific product catalogs
  customerProducts         CustomerProduct[]
  // Customer Card items (карточки клиентов с описаниями и фото)
  customerCardItems        CustomerCardItem[]
  // Material Report relations
  materialReportLines      MaterialReportLine[]
  materialReportDraftLines MaterialReportDraftLine[]
  // Returns relations
  orderReturnItems         OrderReturnItem[]
  // Production Closure relations
  productionClosures       ProductionClosure[]       @relation("ProductionClosures")
}

model Customer {
  id                    Int                   @id @default(autoincrement())
  code                  String                @unique
  name                  String
  legalName             String?
  inn                   String?               @db.VarChar(9) // ИНН клиента (до 9 символов)
  telegramGroupName     String? // Название группы в Telegram
  telegramGroupUsername String? // Никнейм группы (@username)
  districtId            String?
  managerId             String?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  district              District?             @relation(fields: [districtId], references: [code])
  manager               Manager?              @relation(fields: [managerId], references: [code])
  orders                Order[]
  summaryJournalEntries SummaryOrderJournal[]
  salesPriceLists       SalesPriceList[]
  // Customer-specific product catalog (персональный каталог товаров клиента)
  customerProducts      CustomerProduct[]
  // Карточки клиента (MML с описаниями и фото)
  customerCards         CustomerCard[]
}

// Карточка клиента - набор позиций MML с описаниями и фото для конкретного клиента
model CustomerCard {
  id         Int      @id @default(autoincrement())
  customerId Int // FK → Customer
  name       String // Название карточки (например "Основной ассортимент")
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer Customer           @relation(fields: [customerId], references: [id], onDelete: Cascade)
  items    CustomerCardItem[]

  @@index([customerId])
}

// Позиция в карточке клиента - товар с описанием и фото
model CustomerCardItem {
  id          Int      @id @default(autoincrement())
  cardId      Int // FK → CustomerCard
  productId   Int // FK → Product (товар из MML)
  description String?  @db.Text // Детальное описание разделки
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  card    CustomerCard            @relation(fields: [cardId], references: [id], onDelete: Cascade)
  product Product                 @relation(fields: [productId], references: [id])
  photos  CustomerCardItemPhoto[]

  @@unique([cardId, productId])
  @@index([cardId])
  @@index([productId])
}

// Фото для позиции карточки клиента (до 3 фото на позицию)
model CustomerCardItemPhoto {
  id        Int      @id @default(autoincrement())
  itemId    Int // FK → CustomerCardItem
  url       String // URL фото
  sortOrder Int      @default(0) // Порядок фото (0, 1, 2)
  createdAt DateTime @default(now())

  item CustomerCardItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
}

// Связь клиента с его товарами (персональный каталог)
// Позволяет клиенту видеть только те товары, которые он обычно заказывает
model CustomerProduct {
  id         Int      @id @default(autoincrement())
  customerId Int // FK → Customer
  productId  Int // FK → Product
  sortOrder  Int      @default(0) // Порядок отображения в каталоге клиента
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id])

  @@unique([customerId, productId]) // Один товар - один раз у клиента
  @@index([customerId])
  @@index([productId])
}

model Supplier {
  id           Int      @id @default(autoincrement())
  code         String   @unique
  name         String
  legalName    String?
  altName      String? // Альтернативное название поставщика
  phone        String? // Телефон поставщика
  telegram     String? // Telegram поставщика
  isActive     Boolean  @default(true) // Статус активности
  primaryMmlId Int? // FK -> ProductionMml (первичный MML поставщика)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  primaryMml                 ProductionMml?              @relation("SupplierPrimaryMml", fields: [primaryMmlId], references: [id])
  products                   SupplierProduct[]
  purchasePriceListSuppliers PurchasePriceListSupplier[]
  purchasePriceItems         PurchasePriceItem[]
  // Purchase Module relations
  purchases                  PurchaseSupplier[]
  purchaseItems              PurchaseItem[]
  // SVOD Module relations
  svodSupplierCols           SvodSupplierCol[]
  svodSupplierValues         SvodSupplierValue[]
}

model SupplierProduct {
  supplierId Int
  productId  Int
  product    Product  @relation(fields: [productId], references: [id])
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  @@id([supplierId, productId])
}

model Order {
  id          Int      @id @default(autoincrement())
  idn         String? // Сквозной идентификатор из Сводки
  date        DateTime @default(now())
  status      String   @default("NEW") // FSM: NEW → IN_ASSEMBLY → DISTRIBUTING → LOADED → SHIPPED
  paymentType String?
  customerId  Int
  expeditorId Int?
  totalAmount Decimal  @default(0.0)
  totalWeight Float    @default(0.0)
  isDisabled  Boolean  @default(false) // Отключенный заказ (soft-disable)

  // FSM: Бизнес-дата распределения (календарный день в Asia/Tashkent)
  dispatchDay DateTime? @db.Date

  // FSM: Timestamps событий (UTC)
  assemblyStartedAt   DateTime? // Когда начата сборка (NEW → IN_ASSEMBLY)
  assemblyConfirmedAt DateTime? // Когда подтверждена сборка (IN_ASSEMBLY → DISTRIBUTING)
  loadedAt            DateTime? // Когда погружен в машину (DISTRIBUTING → LOADED)
  shippedAt           DateTime? // Когда отгружен (LOADED → SHIPPED)

  // FSM: Кто выполнял действия (auditing)
  assemblyStartedBy   String? // Username кто начал сборку
  assemblyConfirmedBy String? // Username кто подтвердил сборку
  loadedBy            String? // Username кто погрузил (назначил экспедитора)
  shippedBy           String? // Username кто подтвердил отгрузку

  // Expedition fields (legacy, сохраняем для совместимости)
  deliveryAddress  String? // Адрес доставки/точка
  assignedAt       DateTime? // Когда назначен экспедитор
  deliveryStatus   String    @default("pending") // pending, in_delivery, delivered
  completedAt      DateTime? // Когда заказ выполнен
  signatureUrl     String? // Путь к PNG подписи клиента
  signedInvoiceUrl String? // Путь к подписанной накладной PNG

  // Возвраты: агрегаты для быстрого отображения в Сводке
  returnTotalQty Float   @default(0) // Общее кол-во возврата
  returnTotalSum Decimal @default(0) // Сумма возврата
  netTotalSum    Decimal @default(0) // Сумма заказа минус возврат

  // ТЗ v2 §7: Флаг редактирования заказа
  isEdited Boolean   @default(false) // Был ли заказ отредактирован
  editedAt DateTime? // Когда заказ был отредактирован

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  customer          Customer           @relation(fields: [customerId], references: [id])
  expeditor         Expeditor?         @relation(fields: [expeditorId], references: [id])
  items             OrderItem[]
  stockTransactions StockTransaction[]
  attachments       OrderAttachment[]
  returns           OrderReturn[] // Документы возвратов
  returnAuditLogs   ReturnAuditLog[] // Аудит-лог возвратов

  @@index([date])
  @@index([isDisabled])
  @@index([isDisabled, date])
  @@index([dispatchDay])
  @@index([status, dispatchDay])
}

// Вложения к заказу (подписи, накладные, документы)
model OrderAttachment {
  id        Int      @id @default(autoincrement())
  orderId   Int
  type      String // "signature", "signed_invoice", "document"
  filename  String
  url       String // Путь к файлу
  mimeType  String? // image/png, application/pdf
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model OrderItem {
  id                 Int                  @id @default(autoincrement())
  orderId            Int
  productId          Int
  quantity           Float
  price              Decimal
  amount             Decimal
  shippedQty         Float                @default(0.0)
  qtyReturn          Float                @default(0) // Кол-во возврата по позиции
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  distributionCoef   Float?               @default(0.0)
  sumWithRevaluation Decimal?             @default(0.0)
  weightToDistribute Float?               @default(0.0)
  order              Order                @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product            Product              @relation(fields: [productId], references: [id])
  // Связь с SummaryOrderJournal (обратная синхронизация)
  summaryEntry       SummaryOrderJournal?
  returnItems        OrderReturnItem[] // Позиции возвратов
}

// =============================================
// ВОЗВРАТЫ ИЗ ТОЧЕК
// =============================================

// Шапка возврата (один документ на заказ в рамках экспедиции)
model OrderReturn {
  id           Int      @id @default(autoincrement())
  orderId      Int // FK → Order
  expeditionId Int // FK → ExpeditionJournal
  createdBy    String // Username водителя
  status       String   @default("saved") // draft / saved
  totalQty     Float    @default(0) // Общее кол-во возврата
  totalSum     Decimal  @default(0) // Сумма возврата
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  order      Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)
  expedition ExpeditionJournal @relation(fields: [expeditionId], references: [id])
  items      OrderReturnItem[]

  @@unique([orderId, expeditionId]) // ТЗ §5.1: один возврат на заказ в экспедиции
  @@index([orderId])
  @@index([expeditionId])
}

// Позиции возврата (по каждому товару)
model OrderReturnItem {
  id          Int      @id @default(autoincrement())
  returnId    Int // FK → OrderReturn
  orderItemId Int // FK → OrderItem
  productId   Int // FK → Product
  qtyShip     Float // Кол-во к отгрузке (фиксация на момент возврата)
  qtyReturn   Float // Кол-во возврата
  price       Decimal // Цена (фиксация)
  sumShip     Decimal // qtyShip * price
  sumNet      Decimal // (qtyShip - qtyReturn) * price
  createdAt   DateTime @default(now())

  orderReturn OrderReturn @relation(fields: [returnId], references: [id], onDelete: Cascade)
  orderItem   OrderItem   @relation(fields: [orderItemId], references: [id])
  product     Product     @relation(fields: [productId], references: [id])

  @@index([returnId])
  @@index([orderItemId])
}

// Аудит-лог возвратов (ТЗ §9)
model ReturnAuditLog {
  id           Int      @id @default(autoincrement())
  orderId      Int // FK → Order
  returnId     Int? // FK → OrderReturn (null при DELETE)
  expeditionId Int // ID экспедиции
  action       String // CREATED, UPDATED, DELETED
  performedBy  String // Username выполнившего действие
  totalQty     Float // Кол-во возврата на момент события
  totalSum     Decimal // Сумма возврата на момент события
  details      Json? // Доп. данные (позиции, причина и т.д.)
  createdAt    DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([expeditionId])
  @@index([action])
  @@index([createdAt])
}

model Expeditor {
  id        Int      @id @default(autoincrement())
  name      String
  phone     String?
  isActive  Boolean  @default(true)
  userId    Int?     @unique // Optional 1:1 link to User
  user      User?    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    Order[]
}

model Stock {
  productId Int      @id
  quantity  Float    @default(0.0)
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id])
}

model StockTransaction {
  id        Int      @id @default(autoincrement())
  productId Int
  type      String
  quantity  Float
  orderId   Int?
  note      String?
  createdAt DateTime @default(now())
  order     Order?   @relation(fields: [orderId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])
}

// Журнал сводных заказов (Summary Orders Journal)
model SummaryOrderJournal {
  id                 Int      @id @default(autoincrement())
  idn                String // Сквозной идентификатор (одинаковый для одной даты)
  shipDate           DateTime // Дата отгрузки
  paymentType        String?  @default("bank") // Тип оплаты (cash/terminal/bank) - по умолчанию "Перечисление"
  customerId         Int? // Ссылка на клиента
  customerName       String // Название клиента
  productId          Int? // Ссылка на товар
  productCode        String? // Код товара
  productFullName    String // Полное название товара
  category           String? // КП Категория
  shortNameMorning   String? // Название прайс-листа
  priceType          String? // Тип цены
  price              Decimal  @default(0.0) // Цена продажи
  shippedQty         Float    @default(0.0) // Отгружено по факту
  orderQty           Float    @default(0.0) // Заказ (кол-во)
  sumWithRevaluation Decimal? @default(0.0) // Сумма = цена * факт
  distributionCoef   Float?   @default(0.0) // Коэффициент распределения %
  weightToDistribute Float?   @default(0.0) // Вес к распределению
  managerId          String? // ID менеджера
  managerName        String? // ФИО менеджера
  district           String? // Район (из клиента)
  pointAddress       String? // Адрес точки доставки
  status             String   @default("draft") // draft, forming, synced, rework

  // Assembly tracking fields (Отслеживание сборки)
  preAssemblyStatus     String? // Предыдущий статус до отправки в сборку (для возврата)
  assemblyStartedAt     DateTime? // Когда отправлен в сборку
  assemblyStartedBy     String? // Кто отправил в сборку (username)
  assemblyReturnedAt    DateTime? // Когда вернули со сборки
  assemblyReturnedBy    String? // Кто вернул со сборки (username)
  assemblyReturnReason  String? // Причина возврата
  assemblyReturnComment String? // Комментарий к возврату

  // Confirmation tracking (кто подтвердил/сохранил позицию)
  confirmedBy String? // Username кто подтвердил
  confirmedAt DateTime? // Когда подтверждено

  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  customer  Customer?           @relation(fields: [customerId], references: [id])
  product   Product?            @relation(fields: [productId], references: [id])
  events    SummaryOrderEvent[] // История событий

  // Связь с OrderItem (для обратной синхронизации при редактировании заказа)
  orderItemId Int?       @unique // FK -> OrderItem
  orderItem   OrderItem? @relation(fields: [orderItemId], references: [id])

  @@index([shipDate])
  @@index([customerId])
  @@index([category])
  @@index([district])
  @@index([managerId])
  @@index([status])
  @@index([createdAt]) // Для быстрой сортировки
  @@index([shipDate, status]) // Составной индекс для часто используемого фильтра
  @@index([status, createdAt(sort: Desc)]) // Для быстрого получения последних записей по статусу
}

// История событий для записей сводки заказов
model SummaryOrderEvent {
  id             Int      @id @default(autoincrement())
  summaryOrderId Int // FK -> SummaryOrderJournal
  eventType      String // ASSEMBLY_START, ASSEMBLY_RETURN, STATUS_CHANGE, SYNC_TO_ORDER
  fromStatus     String? // Предыдущий статус
  toStatus       String? // Новый статус
  reason         String? // Причина (для возврата)
  comment        String? // Комментарий
  createdAt      DateTime @default(now())
  createdBy      String // Username кто сделал
  payload        Json? // Дополнительные данные (опционально)

  summaryOrder SummaryOrderJournal @relation(fields: [summaryOrderId], references: [id], onDelete: Cascade)

  @@index([summaryOrderId])
  @@index([eventType])
  @@index([createdAt])
}

// Журнал сводок заказов - хранит снимки формы "Сводка заказов"
model SummaryOrdersJournal {
  id          Int      @id @default(autoincrement())
  summaryDate DateTime // дата сводки
  createdAt   DateTime @default(now())
  createdBy   String // имя пользователя
  isHidden    Boolean  @default(false)
  data        Json // все данные формы сводки
}

// Журнал сборок заказов - хранит снимки формы "Сборка заказов"
model AssemblyOrdersJournal {
  id              Int      @id @default(autoincrement())
  assemblyDate    DateTime // дата сборки
  createdAt       DateTime @default(now())
  createdBy       String
  isHidden        Boolean  @default(false)
  sourceSummaryId Int? // ссылка на журнал сводки
  data            Json // все данные сборки
}

// Журнал экспедиции - хранит снимки формы "Экспедиция"
model ExpeditionJournal {
  id            Int      @id @default(autoincrement())
  expeditorId   Int // FK -> Expeditor (экспедитор)
  expeditorName String // Имя экспедитора (кэш)
  dateFrom      DateTime // Дата с
  dateTo        DateTime // Дата по
  status        String   @default("open") // open / closed
  ordersCount   Int      @default(0) // Количество заказов
  totalWeight   Float    @default(0.0) // Общий вес
  totalAmount   Decimal  @default(0.0) // Общая сумма
  createdAt     DateTime @default(now())
  isHidden      Boolean  @default(false)
  data          Json // все данные заказов экспедиции

  returns OrderReturn[] // Возвраты в этой экспедиции

  @@index([expeditorId])
  @@index([dateFrom, dateTo])
  @@index([isHidden])
  @@index([status])
}

// Журнал распределения - хранит снимки формы "Распределение"
model DistributionJournal {
  id          Int      @id @default(autoincrement())
  date        DateTime // Дата распределения
  ordersCount Int      @default(0) // Количество заказов
  totalWeight Float    @default(0.0) // Общий вес
  totalAmount Decimal  @default(0.0) // Общая сумма
  createdAt   DateTime @default(now())
  isHidden    Boolean  @default(false)
  data        Json // все данные заказов распределения

  @@index([date])
  @@index([isHidden])
}

// ============================================
// МОДУЛЬ ПРОИЗВОДСТВА (обновлённый)
// ============================================

// Справочник "Производственный персонал"
model ProductionStaff {
  id        Int      @id @default(autoincrement())
  fullName  String // ФИО
  phone     String? // Телефон
  userId    Int      @unique // FK -> User (связь с системным пользователем)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User                 @relation(fields: [userId], references: [id])
  journals  ProductionJournal[]
  runValues ProductionRunValue[] // Значения выработки, внесённые этим сотрудником
}

// Журнал производства - один документ = одна дата + один мясник
model ProductionJournal {
  id             Int      @id @default(autoincrement())
  productionDate DateTime // Дата производства
  staffId        Int // FK -> ProductionStaff (мясник)
  status         String   @default("draft") // draft / saved / archived
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  updatedBy      String?

  staff ProductionStaff  @relation(fields: [staffId], references: [id])
  items ProductionItem[]

  @@unique([productionDate, staffId]) // Один документ на дату на мясника
  @@index([productionDate])
  @@index([staffId, productionDate])
}

// Карточки/иконки производства (экземпляры записей)
model ProductionItem {
  id          Int       @id @default(autoincrement())
  journalId   Int // FK -> ProductionJournal
  productId   Int? // FK -> Product (может быть NULL пока карточка пустая)
  productName String? // Кэш названия товара
  state       String    @default("editing") // editing / locked
  sortOrder   Int       @default(0)
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  deletedBy   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String
  updatedBy   String?

  journal ProductionJournal     @relation(fields: [journalId], references: [id], onDelete: Cascade)
  product Product?              @relation(fields: [productId], references: [id])
  values  ProductionItemValue[]
}

// Значения полей выработки (расширяемая таблица)
model ProductionItemValue {
  id               Int      @id @default(autoincrement())
  productionItemId Int // FK -> ProductionItem
  fieldKey         String // Ключ поля (qty, weight, etc.)
  fieldValue       String? // Значение
  updatedAt        DateTime @updatedAt
  updatedBy        String?

  productionItem ProductionItem @relation(fields: [productionItemId], references: [id], onDelete: Cascade)

  @@unique([productionItemId, fieldKey])
}

// ============================================
// ПОДСИСТЕМА ПРАЙС-ЛИСТОВ
// ============================================

// Закупочный прайс - шапка документа (ЖУРНАЛ)
model PurchasePriceList {
  id        Int      @id @default(autoincrement())
  date      DateTime // Общая дата прайса / дата вступления в силу
  name      String? // Название/комментарий (опционально)
  isActive  Boolean  @default(true) // Статус (true=активный, false=отключен)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  updatedBy String?

  suppliers PurchasePriceListSupplier[]
  items     PurchasePriceItem[]

  @@index([date])
  @@index([isActive, date])
}

// Связь прайса и поставщика (многие-ко-многим)
// При сохранении фиксируется первичный MML поставщика на момент создания
model PurchasePriceListSupplier {
  id           Int      @id @default(autoincrement())
  priceListId  Int // FK -> PurchasePriceList
  supplierId   Int // FK -> Supplier
  primaryMmlId Int? // FK -> ProductionMml (зафиксированный первичный MML на момент создания прайса)
  createdAt    DateTime @default(now())

  priceList  PurchasePriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  supplier   Supplier          @relation(fields: [supplierId], references: [id])
  primaryMml ProductionMml?    @relation("PriceListSupplierMml", fields: [primaryMmlId], references: [id])

  @@unique([priceListId, supplierId])
  @@index([supplierId])
  @@index([primaryMmlId])
}

// Закупочный прайс - строки (товары по поставщикам)
model PurchasePriceItem {
  id            Int      @id @default(autoincrement())
  priceListId   Int // FK -> PurchasePriceList
  supplierId    Int // FK -> Supplier
  productId     Int // FK -> Product
  purchasePrice Decimal  @db.Decimal(14, 2) // Закупочная цена
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  priceList PurchasePriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  supplier  Supplier          @relation(fields: [supplierId], references: [id])
  product   Product           @relation(fields: [productId], references: [id])

  @@unique([priceListId, supplierId, productId])
  @@index([productId])
  @@index([supplierId])
}

// Продажный прайс - шапка документа
model SalesPriceList {
  id            Int      @id @default(autoincrement())
  listType      String // GENERAL / CUSTOMER
  customerId    Int? // FK -> Customer (только для CUSTOMER)
  title         String? // Название/комментарий
  effectiveDate DateTime // Дата вступления в силу (обязательная)
  status        String   @default("draft") // draft / saved / archived
  isCurrent     Boolean  @default(false) // Текущий активный прайс
  isHidden      Boolean  @default(false) // Скрыт в журнале
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String
  updatedBy     String?

  customer Customer?        @relation(fields: [customerId], references: [id])
  items    SalesPriceItem[]

  @@index([listType, isCurrent])
  @@index([customerId, createdAt])
  @@index([effectiveDate])
  @@index([isHidden, listType])
}

// Продажный прайс - строки
model SalesPriceItem {
  id          Int      @id @default(autoincrement())
  priceListId Int // FK -> SalesPriceList
  productId   Int // FK -> Product
  salePrice   Decimal  @db.Decimal(14, 2) // Цена продажи
  rowDate     DateTime @default(now()) // Дата строки
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  updatedBy   String?

  priceList SalesPriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  product   Product        @relation(fields: [productId], references: [id])

  @@unique([priceListId, productId])
  @@index([productId])
  @@index([rowDate])
}

// ========== PRODUCTION MODULE (v2 - Tree Structure) ==========

// MML (калькуляция/техкарта) - шапка документа
// Один MML на один товар (productId уникален)
model ProductionMml {
  id        Int      @id @default(autoincrement())
  productId Int      @unique // Товар, для которого создан MML
  createdBy Int // User ID создателя
  isLocked  Boolean  @default(false) // Зафиксирован (нельзя редактировать)
  isDeleted Boolean  @default(false) // Мягкое удаление (soft delete)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product             @relation(fields: [productId], references: [id])
  creator User                @relation("MmlCreator", fields: [createdBy], references: [id])
  nodes   ProductionMmlNode[] // Дерево узлов (корневые + подпозиции)
  runs    ProductionRun[] // Выработки по этому MML

  // Обратные связи для первичного MML
  suppliersWithPrimaryMml Supplier[]                  @relation("SupplierPrimaryMml")
  priceListSuppliers      PurchasePriceListSupplier[] @relation("PriceListSupplierMml")
  // Production-Purchase Integration
  cuttingLines            ProductionCuttingLine[]

  @@index([isLocked])
  @@index([isDeleted])
  @@index([createdAt])
}

// MML - узлы дерева (корневые позиции и подпозиции)
// parentNodeId = NULL → корневая позиция
// parentNodeId != NULL → подпозиция (дочерняя)
model ProductionMmlNode {
  id           Int      @id @default(autoincrement())
  mmlId        Int // FK → ProductionMml
  parentNodeId Int? // FK → ProductionMmlNode (NULL = корень)
  productId    Int // FK → Product (товар узла)
  sortOrder    Int      @default(0) // Порядок отображения
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  mml                   ProductionMml              @relation(fields: [mmlId], references: [id], onDelete: Cascade)
  parentNode            ProductionMmlNode?         @relation("NodeChildren", fields: [parentNodeId], references: [id], onDelete: Cascade)
  children              ProductionMmlNode[]        @relation("NodeChildren")
  product               Product                    @relation("MmlNodeProduct", fields: [productId], references: [id])
  runValues             ProductionRunValue[] // Значения в выработках
  shipmentDistributions SvodShipmentDistribution[] // Распределения в своде

  @@index([mmlId])
  @@index([parentNodeId])
  @@index([productId])
  @@index([mmlId, parentNodeId, sortOrder])
}

// Выработка (документ журнала производства)
// Заменяет старый ProductionBatch
model ProductionRun {
  id                      Int      @id @default(autoincrement())
  productId               Int // Что вырабатывается (основной товар)
  mmlId                   Int // Какой MML применён
  userId                  Int // Кто сделал выработку
  productionDate          DateTime @default(now()) // Редактируемая дата выработки
  plannedWeight           Decimal? @db.Decimal(14, 3) // Вес (план) - ввод пользователя
  actualWeight            Decimal? @db.Decimal(14, 3) // Фактический вес (сумма значений)
  isLocked                Boolean  @default(false) // Зафиксировано (нельзя редактировать)
  isHidden                Boolean  @default(false) // Скрыто в журнале
  // Источник позиции
  sourceType              String   @default("MANUAL") // MANUAL | PURCHASE | OPENING_BALANCE
  sourcePurchaseItemId    Int? // FK → PurchaseItem (если sourceType = PURCHASE)
  sourceOpeningBalanceQty Decimal? @db.Decimal(14, 3) // Остаток на начало (если sourceType = OPENING_BALANCE)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  product            Product              @relation("ProductRuns", fields: [productId], references: [id])
  mml                ProductionMml        @relation(fields: [mmlId], references: [id])
  user               User                 @relation("RunUser", fields: [userId], references: [id])
  sourcePurchaseItem PurchaseItem?        @relation(fields: [sourcePurchaseItemId], references: [id])
  values             ProductionRunValue[] // Значения по узлам

  @@index([productId])
  @@index([mmlId])
  @@index([userId])
  @@index([isLocked])
  @@index([createdAt])
  @@index([productionDate])
  @@index([isHidden, productionDate])
  @@index([sourceType])
}

// Значения выработки по узлам MML
// Каждый узел дерева имеет одно числовое значение в документе выработки
// Теперь поддерживает множество записей (строк) на один узел с разными сотрудниками
model ProductionRunValue {
  id                Int      @id @default(autoincrement())
  productionRunId   Int // FK → ProductionRun
  mmlNodeId         Int // FK → ProductionMmlNode
  snapshotProductId Int? // Снимок productId узла на момент выработки (для истории)
  value             Decimal? @db.Decimal(14, 3) // Числовое значение (ввод пользователя)
  staffId           Int? // FK → ProductionStaff (кто внёс значение)
  recordedAt        DateTime @default(now()) // Дата/время записи значения
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  run             ProductionRun     @relation(fields: [productionRunId], references: [id], onDelete: Cascade)
  node            ProductionMmlNode @relation(fields: [mmlNodeId], references: [id])
  snapshotProduct Product?          @relation("RunValueSnapshot", fields: [snapshotProductId], references: [id])
  staff           ProductionStaff?  @relation(fields: [staffId], references: [id])

  @@index([productionRunId])
  @@index([mmlNodeId])
  @@index([staffId])
}

// ============================================
// МОДУЛЬ ЗАКУПКИ
// ============================================

// Справочник типов оплат
model PaymentType {
  id         Int      @id @default(autoincrement())
  name       String   @unique
  isDefault  Boolean  @default(false) // Тип оплаты по умолчанию
  isDisabled Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  purchaseItems PurchaseItem[]
}

// Шапка закупки (документ)
model Purchase {
  id              Int      @id @default(autoincrement())
  idn             String? // Автогенерируемый идентификатор (код_поставщика + дата ДДММГГГГ)
  purchaseDate    DateTime // Дата закупки (редактируемая)
  totalAmount     Decimal? @db.Decimal(14, 2) // Итоговая сумма закупки
  createdByUserId Int? // Кто создал (опционально)
  isDisabled      Boolean  @default(false) // Для скрытия в журнале
  isSystem        Boolean  @default(false) // Виртуальная закупка (OPENING_BALANCE)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  createdByUser    User?              @relation("PurchaseCreator", fields: [createdByUserId], references: [id])
  suppliers        PurchaseSupplier[]
  items            PurchaseItem[]
  // Production-Purchase Integration
  productionInputs ProductionInput[]

  @@index([purchaseDate])
  @@index([isDisabled, purchaseDate])
  @@index([createdByUserId])
}

// Связь закупки с поставщиками (мультипоставщик)
model PurchaseSupplier {
  id         Int      @id @default(autoincrement())
  purchaseId Int
  supplierId Int
  createdAt  DateTime @default(now())

  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  supplier Supplier @relation(fields: [supplierId], references: [id])

  @@unique([purchaseId, supplierId])
  @@index([purchaseId])
  @@index([supplierId])
}

// Строки закупки (товары)
model PurchaseItem {
  id            Int      @id @default(autoincrement())
  purchaseId    Int
  supplierId    Int // Какой поставщик в этой закупке
  productId     Int
  price         Decimal  @db.Decimal(14, 2) // Закупочная цена
  qty           Decimal  @db.Decimal(14, 3) // Количество
  amount        Decimal  @db.Decimal(14, 2) // Сумма (price * qty)
  paymentTypeId Int? // Тип оплаты (может быть разный для каждой строки)
  isSystem      Boolean  @default(false) // Виртуальная партия (OPENING_BALANCE)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  purchase         Purchase              @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  supplier         Supplier              @relation(fields: [supplierId], references: [id])
  product          Product               @relation("PurchaseItemProduct", fields: [productId], references: [id])
  paymentType      PaymentType?          @relation(fields: [paymentTypeId], references: [id])
  // Production-Purchase Integration
  productionInputs ProductionInput[]
  productionRuns   ProductionRun[] // Выработки, созданные из этой закупки
  // Production Closure relation
  lotClosure       ProductionLotClosure? // Закрытие партии (1:1)

  @@index([purchaseId, supplierId])
  @@index([purchaseId])
  @@index([supplierId])
  @@index([productId])
}

// ============================================
// TELEGRAM USERBOT MODULE
// ============================================

// Группы Telegram для мониторинга
model TelegramGroup {
  id            Int      @id @default(autoincrement())
  chatId        String   @unique // Telegram chat ID (может быть отрицательным)
  title         String // Название группы
  username      String? // @username группы (если публичная)
  isActive      Boolean  @default(true) // Активен ли мониторинг
  lastMessageId Int? // ID последнего обработанного сообщения
  parsePatterns Json? // Кастомные regex-шаблоны для парсинга заказов
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  orderDrafts TelegramOrderDraft[]

  @@index([isActive])
}

// Черновики заказов из Telegram (перед переносом в Order)
model TelegramOrderDraft {
  id          Int      @id @default(autoincrement())
  groupId     Int // FK -> TelegramGroup
  messageId   String // Telegram message ID
  messageText String // Оригинальный текст сообщения
  messageDate DateTime // Дата сообщения в Telegram
  senderName  String? // Имя отправителя
  senderId    String? // Telegram ID отправителя

  // Распознанные данные
  parsedOrderNumber String? // Номер заказа (если распознан)
  parsedCustomer    String? // Клиент (если распознан)
  parsedAddress     String? // Адрес доставки (если распознан)

  status             String    @default("pending") // pending, approved, rejected, transferred
  transferredOrderId Int? // FK -> Order (если заказ перенесён)
  approvedBy         String? // Кто одобрил
  approvedAt         DateTime?
  rejectedReason     String? // Причина отклонения

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group TelegramGroup            @relation(fields: [groupId], references: [id], onDelete: Cascade)
  items TelegramOrderDraftItem[]

  @@unique([groupId, messageId])
  @@index([status])
  @@index([createdAt])
}

// Строки черновика заказа
model TelegramOrderDraftItem {
  id      Int @id @default(autoincrement())
  draftId Int // FK -> TelegramOrderDraft

  // Распознанные данные из сообщения
  rawProductName String // Как написано в сообщении
  rawQuantity    String // Как написано в сообщении (например "10кг" или "5 шт")
  rawPrice       String? // Цена (если указана)

  // Связь с реальными данными (заполняется при подтверждении)
  productId Int? // FK -> Product (если сопоставлен)
  quantity  Float? // Преобразованное количество
  price     Decimal? @db.Decimal(14, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  draft TelegramOrderDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@index([draftId])
  @@index([productId])
}

// ============================================
// WAREHOUSE MODULE (Справочник складов)
// ============================================

model Warehouse {
  id                Int     @id @default(autoincrement())
  code              String  @unique // Уникальный код склада для импорта
  name              String // Название склада (обяз.)
  address           String // Адрес склада (обяз.)
  phone             String? // Телефон
  responsibleUserId Int? // FK → User (ответственный)
  comment           String? // Комментарий
  isDisabled        Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  responsibleUser User? @relation("WarehouseResponsible", fields: [responsibleUserId], references: [id])

  // Production-Purchase Integration
  productionDocs       ProductionDoc[]
  productionInputs     ProductionInput[]
  // Material Report relations
  materialReports      MaterialReport[]
  materialReportDrafts MaterialReportDraft[]

  @@index([name])
  @@index([isDisabled])
}

// ============================================
// МОДУЛЬ СВОД (Сводная таблица заказов)
// ============================================

// Шапка свода (один документ на дату)
model SvodHeader {
  id        Int      @id @default(autoincrement())
  svodDate  DateTime @db.Date // Дата формирования свода (D)
  status    String   @default("draft") // draft / saved / edited
  createdAt DateTime @default(now())
  createdBy String // username кто создал
  updatedAt DateTime @updatedAt
  updatedBy String? // username кто правил

  lines                SvodLine[]
  supplierCols         SvodSupplierCol[]
  supplierValues       SvodSupplierValue[]
  // Material Report Draft relation
  materialReportDrafts MaterialReportDraft[]

  @@unique([svodDate]) // Один свод на дату
  @@index([status])
}

// Строки свода по товарам
model SvodLine {
  id        Int @id @default(autoincrement())
  svodId    Int // FK -> SvodHeader
  productId Int // FK -> Product

  // Snapshot полей из справочника (на момент сохранения)
  shortName   String? // Название прайс-листа (snapshot)
  category    String? // Категория товара (snapshot)
  coefficient Decimal? @db.Decimal(10, 4) // Коэффициент (snapshot)

  // Источниковые поля (автоматически подтягиваемые)
  orderQty        Decimal @default(0) @db.Decimal(14, 3) // Заказ (из Сводки заказов)
  productionInQty Decimal @default(0) @db.Decimal(14, 3) // Приход с производства

  // Редактируемые поля
  openingStock         Decimal  @default(0) @db.Decimal(14, 3) // Остаток на начало дня
  openingStockIsManual Boolean  @default(false) // Ручная правка остатка
  afterPurchaseStock   Decimal? @db.Decimal(14, 3) // Остаток после закупки
  afterShipmentStock   Decimal? @db.Decimal(14, 3) // Остаток после отгрузки

  // Расчётные поля (формульные, placeholder - формулы будут позже)
  qtyToShip      Decimal? @db.Decimal(14, 3) // Количество к отгрузке
  factMinusWaste Decimal? @db.Decimal(14, 3) // Факт (минус отходы)
  weightToShip   Decimal? @db.Decimal(14, 3) // Вес к отгрузке
  planFactDiff   Decimal? @db.Decimal(14, 3) // Разница план-факт
  underOver      Decimal? @db.Decimal(14, 3) // Недобор-перебор

  // Маркировка распределения
  isDistributionSource  Boolean @default(false) // Позиция-источник распределения
  distributedFromLineId Int? // FK -> SvodLine (родительская позиция)
  distributedFromName   String? // Краткое название родительской позиции (для отображения)

  sortOrder Int @default(0) // Порядок в блоке категории

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  svod                  SvodHeader                 @relation(fields: [svodId], references: [id], onDelete: Cascade)
  product               Product                    @relation(fields: [productId], references: [id])
  shipmentDistributions SvodShipmentDistribution[] // Распределение по MML

  @@unique([svodId, productId]) // Один товар = одна строка в своде
  @@index([svodId])
  @@index([productId])
  @@index([category])
  @@index([distributedFromLineId])
}

// Колонки поставщиков в своде (до 10 штук)
model SvodSupplierCol {
  id            Int     @id @default(autoincrement())
  svodId        Int // FK -> SvodHeader
  colIndex      Int // Позиция 1..10
  supplierId    Int // FK -> Supplier
  supplierName  String // Snapshot имени поставщика
  totalPurchase Decimal @default(0) @db.Decimal(14, 2) // Общая сумма закупки (для сортировки ТОП-10)

  createdAt DateTime @default(now())

  svod     SvodHeader @relation(fields: [svodId], references: [id], onDelete: Cascade)
  supplier Supplier   @relation(fields: [supplierId], references: [id])

  @@unique([svodId, colIndex]) // Один индекс = одна колонка
  @@unique([svodId, supplierId]) // Один поставщик не повторяется
  @@index([svodId])
}

// Значения закупа по поставщикам для каждой строки товара
model SvodSupplierValue {
  id          Int     @id @default(autoincrement())
  svodId      Int // FK -> SvodHeader
  productId   Int // FK -> Product
  supplierId  Int // FK -> Supplier
  purchaseQty Decimal @default(0) @db.Decimal(14, 3) // Количество закупа

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  svod     SvodHeader @relation(fields: [svodId], references: [id], onDelete: Cascade)
  product  Product    @relation(fields: [productId], references: [id])
  supplier Supplier   @relation(fields: [supplierId], references: [id])

  @@unique([svodId, productId, supplierId]) // Уникальная комбинация
  @@index([svodId])
  @@index([productId])
  @@index([supplierId])
}

// Распределение веса отгрузки по позициям техкарты (MML)
model SvodShipmentDistribution {
  id             Int      @id @default(autoincrement())
  svodLineId     Int // FK → SvodLine
  mmlNodeId      Int // FK → ProductionMmlNode (позиция из техкарты)
  distributedQty Decimal  @db.Decimal(14, 3) // Распределённое количество
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  svodLine SvodLine          @relation(fields: [svodLineId], references: [id], onDelete: Cascade)
  mmlNode  ProductionMmlNode @relation(fields: [mmlNodeId], references: [id])

  @@unique([svodLineId, mmlNodeId]) // Один узел = одно распределение на строку
  @@index([svodLineId])
  @@index([mmlNodeId])
}

// ============================================
// ИНТЕГРАЦИЯ ПРОИЗВОДСТВО-ЗАКУПКА
// ============================================

// Документ производства (шапка)
model ProductionDoc {
  id              Int      @id @default(autoincrement())
  date            DateTime @db.Date // Дата производства
  warehouseId     Int // FK → Warehouse (склад-приёмник)
  status          String   @default("draft") // draft / loaded / cutting / done / canceled
  createdByUserId Int // FK → User
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  warehouse    Warehouse               @relation(fields: [warehouseId], references: [id])
  createdBy    User                    @relation("ProductionDocCreator", fields: [createdByUserId], references: [id])
  inputs       ProductionInput[]
  outputs      ProductionOutput[]
  cuttingLines ProductionCuttingLine[]

  @@unique([date, warehouseId]) // Один документ на дату и склад
  @@index([date])
  @@index([status])
  @@index([warehouseId])
}

// Входные партии сырья (из закупки)
model ProductionInput {
  id              Int      @id @default(autoincrement())
  productionDocId Int // FK → ProductionDoc
  purchaseId      Int // FK → Purchase (документ закупки)
  purchaseItemId  Int // FK → PurchaseItem (конкретная строка закупа)
  productId       Int // FK → Product
  warehouseId     Int // FK → Warehouse
  qtyIn           Decimal  @db.Decimal(14, 3) // Кол-во загружено
  qtyUsed         Decimal  @default(0) @db.Decimal(14, 3) // Сколько уже использовано в разделке
  priceIn         Decimal? @db.Decimal(14, 2) // Закупочная цена (опционально)
  loadedAt        DateTime @default(now())
  loadedByUserId  Int // FK → User

  productionDoc ProductionDoc           @relation(fields: [productionDocId], references: [id], onDelete: Cascade)
  purchase      Purchase                @relation(fields: [purchaseId], references: [id])
  purchaseItem  PurchaseItem            @relation(fields: [purchaseItemId], references: [id])
  product       Product                 @relation("ProductionInputProduct", fields: [productId], references: [id])
  warehouse     Warehouse               @relation(fields: [warehouseId], references: [id])
  loadedBy      User                    @relation("ProductionInputLoader", fields: [loadedByUserId], references: [id])
  cuttingLines  ProductionCuttingLine[]

  @@unique([productionDocId, purchaseItemId]) // Одна позиция закупа = один раз в документе
  @@index([productionDocId])
  @@index([purchaseItemId])
  @@index([productId])
  @@index([purchaseId])
}

// Выход после разделки (результат производства)
model ProductionOutput {
  id              Int      @id @default(autoincrement())
  productionDocId Int // FK → ProductionDoc
  productId       Int // FK → Product (выходная часть/товар)
  qtyOut          Decimal  @db.Decimal(14, 3) // Количество выхода
  uom             String   @default("kg") // Ед. измерения (kg / pcs)
  costTotal       Decimal? @db.Decimal(14, 2) // Себестоимость общая
  costPerUnit     Decimal? @db.Decimal(14, 4) // Себестоимость за единицу
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  productionDoc ProductionDoc @relation(fields: [productionDocId], references: [id], onDelete: Cascade)
  product       Product       @relation("ProductionOutputProduct", fields: [productId], references: [id])

  @@unique([productionDocId, productId]) // Один товар = одна строка выхода
  @@index([productionDocId])
  @@index([productId])
}

// Линии разделки по MML (детализация: какое сырьё → какой выход)
model ProductionCuttingLine {
  id                Int      @id @default(autoincrement())
  productionDocId   Int // FK → ProductionDoc
  productionInputId Int // FK → ProductionInput (из какой партии сырья)
  mmlId             Int // FK → ProductionMml (какой MML применён)
  outProductId      Int // FK → Product (выходной товар)
  qtyOut            Decimal  @db.Decimal(14, 3) // Кол-во выхода
  qtyInConsumed     Decimal  @db.Decimal(14, 3) // Сколько сырья израсходовано
  createdAt         DateTime @default(now())
  createdByUserId   Int // FK → User

  productionDoc   ProductionDoc   @relation(fields: [productionDocId], references: [id], onDelete: Cascade)
  productionInput ProductionInput @relation(fields: [productionInputId], references: [id])
  mml             ProductionMml   @relation(fields: [mmlId], references: [id])
  outProduct      Product         @relation("CuttingLineOutput", fields: [outProductId], references: [id])
  createdBy       User            @relation("CuttingLineCreator", fields: [createdByUserId], references: [id])

  @@index([productionDocId])
  @@index([productionInputId])
  @@index([mmlId])
  @@index([outProductId])
}

// ============================================
// МАТЕРИАЛЬНЫЙ ОТЧЁТ (Material Report)
// ============================================

// Шапка материального отчёта (один документ на дату + склад)
model MaterialReport {
  id          Int      @id @default(autoincrement())
  reportDate  DateTime @db.Date // Дата отчёта (= дата заказов)
  warehouseId Int? // FK → Warehouse (опционально)
  sourceType  String? // Тип источника: 'ORDER_SUMMARY', 'MANUAL'
  sourceId    Int? // ID источника (order_summary_id или null)
  status      String   @default("draft") // draft / saved / closed
  createdAt   DateTime @default(now())
  createdBy   String // username кто создал
  updatedAt   DateTime @updatedAt
  updatedBy   String? // username кто обновил

  lines     MaterialReportLine[]
  warehouse Warehouse?           @relation(fields: [warehouseId], references: [id])

  @@unique([reportDate, warehouseId]) // Один отчёт на дату и склад
  @@index([reportDate])
  @@index([status])
  @@index([warehouseId])
}

// Строки материального отчёта (по товарам)
model MaterialReportLine {
  id               Int @id @default(autoincrement())
  materialReportId Int // FK → MaterialReport
  productId        Int // FK → Product

  // Snapshot полей из справочника
  productCode String? // Код товара
  productName String? // Наименование товара

  // Движения и остатки
  openingBalance        Decimal  @default(0) @db.Decimal(14, 3) // Остаток на начало
  inPurchase            Decimal  @default(0) @db.Decimal(14, 3) // Купили (закупка)
  inProduction          Decimal  @default(0) @db.Decimal(14, 3) // Приход с производства
  outSale               Decimal  @default(0) @db.Decimal(14, 3) // Продали (отгрузка)
  outWaste              Decimal  @default(0) @db.Decimal(14, 3) // Отход
  outBundle             Decimal  @default(0) @db.Decimal(14, 3) // Пучок
  outDefectWriteoff     Decimal  @default(0) @db.Decimal(14, 3) // Списали брак
  outProductionWriteoff Decimal  @default(0) @db.Decimal(14, 3) // Списано в производство
  outWeightLoss         Decimal  @default(0) @db.Decimal(14, 3) // Списали (потеря веса)
  outSupplierReturn     Decimal  @default(0) @db.Decimal(14, 3) // Возврат поставщику
  closingBalanceCalc    Decimal  @default(0) @db.Decimal(14, 3) // Остаток на конец (расчётный)
  closingBalanceFact    Decimal? @db.Decimal(14, 3) // Фактический остаток (ручной ввод)

  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  materialReport MaterialReport @relation(fields: [materialReportId], references: [id], onDelete: Cascade)
  product        Product        @relation(fields: [productId], references: [id])

  @@unique([materialReportId, productId]) // Один товар = одна строка в отчёте
  @@index([materialReportId])
  @@index([productId])
}

// Черновик материального отчёта (для вкладки "Отчет" в своде)
// Хранит введённые пользователем факт остатки до сохранения в основной отчёт
model MaterialReportDraft {
  id           Int      @id @default(autoincrement())
  reportDate   DateTime @db.Date // Дата отчёта (= дата заказов)
  warehouseId  Int? // FK → Warehouse
  svodHeaderId Int? // FK → SvodHeader (связь со сводом)
  updatedAt    DateTime @updatedAt
  updatedBy    String? // username

  lines      MaterialReportDraftLine[]
  warehouse  Warehouse?                @relation(fields: [warehouseId], references: [id])
  svodHeader SvodHeader?               @relation(fields: [svodHeaderId], references: [id])

  @@unique([reportDate, warehouseId]) // Один черновик на дату и склад
  @@index([reportDate])
  @@index([svodHeaderId])
}

// Строки черновика материального отчёта
model MaterialReportDraftLine {
  id        Int @id @default(autoincrement())
  draftId   Int // FK → MaterialReportDraft
  productId Int // FK → Product

  // Все поля движений (для кэширования расчётных значений)
  openingBalance        Decimal  @default(0) @db.Decimal(14, 3)
  inPurchase            Decimal  @default(0) @db.Decimal(14, 3)
  inProduction          Decimal  @default(0) @db.Decimal(14, 3)
  outSale               Decimal  @default(0) @db.Decimal(14, 3)
  outWaste              Decimal  @default(0) @db.Decimal(14, 3)
  outBundle             Decimal  @default(0) @db.Decimal(14, 3)
  outDefectWriteoff     Decimal  @default(0) @db.Decimal(14, 3)
  outProductionWriteoff Decimal  @default(0) @db.Decimal(14, 3) // Списано в производство
  outWeightLoss         Decimal  @default(0) @db.Decimal(14, 3)
  outSupplierReturn     Decimal  @default(0) @db.Decimal(14, 3)
  closingBalanceCalc    Decimal  @default(0) @db.Decimal(14, 3)
  closingBalanceFact    Decimal? @db.Decimal(14, 3) // Введённый пользователем факт

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  draft   MaterialReportDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)
  product Product             @relation(fields: [productId], references: [id])

  @@unique([draftId, productId])
  @@index([draftId])
  @@index([productId])
}

// ============================================
// PRODUCTION CLOSURE MODULE (V3)
// ============================================

// Закрытие партии закупки (по purchaseItemId)
// Хранит состояние выработки конкретной партии
model ProductionLotClosure {
  id             Int @id @default(autoincrement())
  purchaseItemId Int @unique // FK → PurchaseItem

  status String @default("open") // open | closed

  qtyPurchased Decimal @default(0) @db.Decimal(14, 3) // Сколько закупили
  qtyProduced  Decimal @default(0) @db.Decimal(14, 3) // Сколько выработали
  qtyRemaining Decimal @default(0) @db.Decimal(14, 3) // Остаток (qtyPurchased - qtyProduced)

  closedAt   DateTime?
  closedBy   String?
  reopenedAt DateTime?
  reopenedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchaseItem PurchaseItem @relation(fields: [purchaseItemId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([status, purchaseItemId])
}

// Закрытие продукта на дату (по productionDate + productId)
// Хранит итоговое состояние выработки продукта за день
model ProductionClosure {
  id             Int      @id @default(autoincrement())
  productionDate DateTime @db.Date // Дата производства
  productId      Int // FK → Product

  status String @default("open") // open | closed

  totalIn       Decimal @default(0) @db.Decimal(14, 3) // Закуп + carryover
  totalProduced Decimal @default(0) @db.Decimal(14, 3) // Сумма выработки (actualWeight)
  diffAbs       Decimal @default(0) @db.Decimal(14, 3) // ABS(totalIn - totalProduced)

  closedAt   DateTime?
  closedBy   String?
  reopenedAt DateTime?
  reopenedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation("ProductionClosures", fields: [productId], references: [id])

  @@unique([productionDate, productId])
  @@index([productionDate])
  @@index([productId])
  @@index([status])
}

// Аудит закрытий производства
model ProductionClosureAudit {
  id             Int       @id @default(autoincrement())
  scope          String // LOT | PRODUCT
  action         String // CLOSED | REOPENED | RECALC
  productionDate DateTime? @db.Date
  productId      Int?
  purchaseItemId Int?
  performedBy    String
  payload        Json? // Дополнительные данные (старые/новые значения)
  createdAt      DateTime  @default(now())

  @@index([scope])
  @@index([productionDate])
  @@index([productId])
  @@index([purchaseItemId])
  @@index([createdAt])
}
