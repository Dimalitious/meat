generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         Int      @id @default(autoincrement())
  username   String   @unique
  password   String
  name       String
  role       String   @default("USER")
  telegramId String?  @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model District {
  id        Int        @id @default(autoincrement())
  code      String     @unique
  name      String
  customers Customer[]
}

model Manager {
  id        Int        @id @default(autoincrement())
  code      String     @unique
  name      String
  phone     String?
  customers Customer[]
}

model Product {
  id                Int                @id @default(autoincrement())
  code              String             @unique
  name              String
  altName           String?
  shortNameFsa      String?
  shortNamePl       String?
  shortNameMorning  String?
  priceMorning      Decimal?           @default(0.0)
  category          String?
  status            String             @default("active")
  coefficient       Float              @default(1.0)
  lossNorm          Float              @default(0.0)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  orderItems            OrderItem[]
  stock                 Stock?
  stockTransactions     StockTransaction[]
  suppliers             SupplierProduct[]
  summaryJournalEntries SummaryOrderJournal[]
}

model Customer {
  id         Int       @id @default(autoincrement())
  code       String    @unique
  name       String
  legalName  String?
  districtId String?
  managerId  String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  district              District? @relation(fields: [districtId], references: [code])
  manager               Manager?  @relation(fields: [managerId], references: [code])
  orders                Order[]
  summaryJournalEntries SummaryOrderJournal[]
}

model Supplier {
  id        Int               @id @default(autoincrement())
  code      String            @unique
  name      String
  legalName String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  products  SupplierProduct[]
}

model SupplierProduct {
  supplierId Int
  productId  Int
  product    Product  @relation(fields: [productId], references: [id])
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  @@id([supplierId, productId])
}

model Order {
  id                Int                @id @default(autoincrement())
  idn               String?            // Сквозной идентификатор из Сводки
  date              DateTime           @default(now())
  status            String             @default("new")
  paymentType       String?
  customerId        Int
  expeditorId       Int?
  totalAmount       Decimal            @default(0.0)
  totalWeight       Float              @default(0.0)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  customer          Customer           @relation(fields: [customerId], references: [id])
  expeditor         Expeditor?         @relation(fields: [expeditorId], references: [id])
  items             OrderItem[]
  stockTransactions StockTransaction[]
}

model OrderItem {
  id                 Int      @id @default(autoincrement())
  orderId            Int
  productId          Int
  quantity           Float
  price              Decimal
  amount             Decimal
  shippedQty         Float    @default(0.0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  distributionCoef   Float?   @default(0.0)
  sumWithRevaluation Decimal? @default(0.0)
  weightToDistribute Float?   @default(0.0)
  order              Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product            Product  @relation(fields: [productId], references: [id])
}

model Expeditor {
  id        Int      @id @default(autoincrement())
  name      String
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    Order[]
}

model Stock {
  productId Int      @id
  quantity  Float    @default(0.0)
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id])
}

model StockTransaction {
  id        Int      @id @default(autoincrement())
  productId Int
  type      String
  quantity  Float
  orderId   Int?
  note      String?
  createdAt DateTime @default(now())
  order     Order?   @relation(fields: [orderId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])
}

// Журнал сводных заказов (Summary Orders Journal)
model SummaryOrderJournal {
  id                  Int       @id @default(autoincrement())
  idn                 String             // Сквозной идентификатор (одинаковый для одной даты)
  shipDate            DateTime  // Дата отгрузки
  paymentType         String?   // Тип оплаты (cash/terminal/bank)
  customerId          Int?      // Ссылка на клиента
  customerName        String    // Название клиента
  productId           Int?      // Ссылка на товар
  productFullName     String    // Полное название товара
  category            String?   // КП Категория
  shortNameMorning    String?   // КП короткое название для утреннего отгрузки
  priceType           String?   // Тип цены
  price               Decimal   @default(0.0)  // Цена продажи
  shippedQty          Float     @default(0.0)  // Отгружено по факту
  orderQty            Float     @default(0.0)  // Заказ (кол-во)
  sumWithRevaluation  Decimal?  @default(0.0)  // Сумма с переоценкой = цена * shippedQty
  distributionCoef    Float?    @default(0.0)  // Коэффициент распределения %
  weightToDistribute  Float?    @default(0.0)  // Вес к распределению
  managerId           String?   // Ссылка на менеджера
  managerName         String?   // Менеджер ответственный (автозаполнение)
  status              String    @default("draft") // draft, forming, synced, rework
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  customer            Customer? @relation(fields: [customerId], references: [id])
  product             Product?  @relation(fields: [productId], references: [id])
}

// Журнал сводок заказов - хранит снимки формы "Сводка заказов"
model SummaryOrdersJournal {
  id          Int       @id @default(autoincrement())
  summaryDate DateTime  // дата сводки
  createdAt   DateTime  @default(now())
  createdBy   String    // имя пользователя
  isHidden    Boolean   @default(false)
  data        Json      // все данные формы сводки
}

// Журнал сборок заказов - хранит снимки формы "Сборка заказов"
model AssemblyOrdersJournal {
  id              Int       @id @default(autoincrement())
  assemblyDate    DateTime  // дата сборки
  createdAt       DateTime  @default(now())
  createdBy       String
  isHidden        Boolean   @default(false)
  sourceSummaryId Int?      // ссылка на журнал сводки
  data            Json      // все данные сборки
}
