generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int               @id @default(autoincrement())
  username        String            @unique
  password        String
  name            String
  role            String            @default("USER")
  telegramId      String?           @unique
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  productionStaff ProductionStaff?
  // Production Module v2 relations
  createdMmls     ProductionMml[]   @relation("MmlCreator")
  productionRuns  ProductionRun[]   @relation("RunUser")
}

model District {
  id        Int        @id @default(autoincrement())
  code      String     @unique
  name      String
  customers Customer[]
}

model Manager {
  id        Int        @id @default(autoincrement())
  code      String     @unique
  name      String
  phone     String?
  customers Customer[]
}

model Product {
  id                Int                @id @default(autoincrement())
  code              String             @unique
  name              String             // Полное название
  altName           String?            // Альтернативное название
  priceListName     String?            // Название прайс-листа (было shortNameMorning)
  category          String?
  status            String             @default("active")
  coefficient       Float              @default(1.0)
  lossNorm          Float              @default(0.0)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  orderItems            OrderItem[]
  stock                 Stock?
  stockTransactions     StockTransaction[]
  suppliers             SupplierProduct[]
  summaryJournalEntries SummaryOrderJournal[]
  productionItems       ProductionItem[]
  purchasePriceItems    PurchasePriceItem[]
  salesPriceItems       SalesPriceItem[]
  // Production Module v2 relations
  productionMmls        ProductionMml[]           // MML для этого товара
  mmlNodes              ProductionMmlNode[]       @relation("MmlNodeProduct")  // Узлы MML где этот товар
  productionRuns        ProductionRun[]           @relation("ProductRuns")     // Выработки этого товара
}

model Customer {
  id         Int       @id @default(autoincrement())
  code       String    @unique
  name       String
  legalName  String?
  districtId String?
  managerId  String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  district              District? @relation(fields: [districtId], references: [code])
  manager               Manager?  @relation(fields: [managerId], references: [code])
  orders                Order[]
  summaryJournalEntries SummaryOrderJournal[]
  salesPriceLists       SalesPriceList[]
}

model Supplier {
  id           Int               @id @default(autoincrement())
  code         String            @unique
  name         String
  legalName    String?
  altName      String?           // Альтернативное название поставщика
  phone        String?           // Телефон поставщика
  telegram     String?           // Telegram поставщика
  isActive     Boolean           @default(true)  // Статус активности
  primaryMmlId Int?              // FK -> ProductionMml (первичный MML поставщика)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  
  primaryMml   ProductionMml?    @relation("SupplierPrimaryMml", fields: [primaryMmlId], references: [id])
  products     SupplierProduct[]
  purchasePriceListSuppliers PurchasePriceListSupplier[]
  purchasePriceItems         PurchasePriceItem[]
}

model SupplierProduct {
  supplierId Int
  productId  Int
  product    Product  @relation(fields: [productId], references: [id])
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  @@id([supplierId, productId])
}

model Order {
  id                Int                @id @default(autoincrement())
  idn               String?            // Сквозной идентификатор из Сводки
  date              DateTime           @default(now())
  status            String             @default("new") // new, assigned, in_delivery, delivered, cancelled
  paymentType       String?
  customerId        Int
  expeditorId       Int?
  totalAmount       Decimal            @default(0.0)
  totalWeight       Float              @default(0.0)
  isDisabled        Boolean            @default(false)  // Отключенный заказ (soft-disable)
  
  // Expedition fields
  deliveryAddress   String?            // Адрес доставки/точка
  assignedAt        DateTime?          // Когда назначен экспедитор
  deliveryStatus    String  @default("pending") // pending, in_delivery, delivered
  completedAt       DateTime?          // Когда заказ выполнен
  signatureUrl      String?            // Путь к PNG подписи клиента
  signedInvoiceUrl  String?            // Путь к подписанной накладной PNG
  
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  customer          Customer           @relation(fields: [customerId], references: [id])
  expeditor         Expeditor?         @relation(fields: [expeditorId], references: [id])
  items             OrderItem[]
  stockTransactions StockTransaction[]
  attachments       OrderAttachment[]
  
  @@index([date])
  @@index([isDisabled])
  @@index([isDisabled, date])
}

// Вложения к заказу (подписи, накладные, документы)
model OrderAttachment {
  id        Int      @id @default(autoincrement())
  orderId   Int
  type      String   // "signature", "signed_invoice", "document"
  filename  String
  url       String   // Путь к файлу
  mimeType  String?  // image/png, application/pdf
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model OrderItem {
  id                 Int      @id @default(autoincrement())
  orderId            Int
  productId          Int
  quantity           Float
  price              Decimal
  amount             Decimal
  shippedQty         Float    @default(0.0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  distributionCoef   Float?   @default(0.0)
  sumWithRevaluation Decimal? @default(0.0)
  weightToDistribute Float?   @default(0.0)
  order              Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product            Product  @relation(fields: [productId], references: [id])
}

model Expeditor {
  id        Int      @id @default(autoincrement())
  name      String
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    Order[]
}

model Stock {
  productId Int      @id
  quantity  Float    @default(0.0)
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id])
}

model StockTransaction {
  id        Int      @id @default(autoincrement())
  productId Int
  type      String
  quantity  Float
  orderId   Int?
  note      String?
  createdAt DateTime @default(now())
  order     Order?   @relation(fields: [orderId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])
}

// Журнал сводных заказов (Summary Orders Journal)
model SummaryOrderJournal {
  id                  Int       @id @default(autoincrement())
  idn                 String             // Сквозной идентификатор (одинаковый для одной даты)
  shipDate            DateTime  // Дата отгрузки
  paymentType         String?   @default("bank") // Тип оплаты (cash/terminal/bank) - по умолчанию "Перечисление"
  customerId          Int?      // Ссылка на клиента
  customerName        String    // Название клиента
  productId           Int?      // Ссылка на товар
  productCode         String?   // Код товара
  productFullName     String    // Полное название товара
  category            String?   // КП Категория
  shortNameMorning    String?   // Название прайс-листа
  priceType           String?   // Тип цены
  price               Decimal   @default(0.0)  // Цена продажи
  shippedQty          Float     @default(0.0)  // Отгружено по факту
  orderQty            Float     @default(0.0)  // Заказ (кол-во)
  sumWithRevaluation  Decimal?  @default(0.0)  // Сумма = цена * факт
  distributionCoef    Float?    @default(0.0)  // Коэффициент распределения %
  weightToDistribute  Float?    @default(0.0)  // Вес к распределению
  managerId           String?   // ID менеджера
  managerName         String?   // ФИО менеджера
  district            String?   // Район (из клиента)
  pointAddress        String?   // Адрес точки доставки
  status              String    @default("draft") // draft, forming, synced, rework
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  customer            Customer? @relation(fields: [customerId], references: [id])
  product             Product?  @relation(fields: [productId], references: [id])
  
  @@index([shipDate])
  @@index([customerId])
  @@index([category])
  @@index([district])
  @@index([managerId])
}

// Журнал сводок заказов - хранит снимки формы "Сводка заказов"
model SummaryOrdersJournal {
  id          Int       @id @default(autoincrement())
  summaryDate DateTime  // дата сводки
  createdAt   DateTime  @default(now())
  createdBy   String    // имя пользователя
  isHidden    Boolean   @default(false)
  data        Json      // все данные формы сводки
}

// Журнал сборок заказов - хранит снимки формы "Сборка заказов"
model AssemblyOrdersJournal {
  id              Int       @id @default(autoincrement())
  assemblyDate    DateTime  // дата сборки
  createdAt       DateTime  @default(now())
  createdBy       String
  isHidden        Boolean   @default(false)
  sourceSummaryId Int?      // ссылка на журнал сводки
  data            Json      // все данные сборки
}

// ============================================
// МОДУЛЬ ПРОИЗВОДСТВА (обновлённый)
// ============================================

// Справочник "Производственный персонал"
model ProductionStaff {
  id          Int       @id @default(autoincrement())
  fullName    String    // ФИО
  phone       String?   // Телефон
  userId      Int       @unique  // FK -> User (связь с системным пользователем)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  user        User      @relation(fields: [userId], references: [id])
  journals    ProductionJournal[]
}

// Журнал производства - один документ = одна дата + один мясник
model ProductionJournal {
  id              Int       @id @default(autoincrement())
  productionDate  DateTime  // Дата производства
  staffId         Int       // FK -> ProductionStaff (мясник)
  status          String    @default("draft")  // draft / saved / archived
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       String
  updatedBy       String?
  
  staff           ProductionStaff @relation(fields: [staffId], references: [id])
  items           ProductionItem[]
  
  @@unique([productionDate, staffId])  // Один документ на дату на мясника
  @@index([productionDate])
  @@index([staffId, productionDate])
}

// Карточки/иконки производства (экземпляры записей)
model ProductionItem {
  id            Int       @id @default(autoincrement())
  journalId     Int       // FK -> ProductionJournal
  productId     Int?      // FK -> Product (может быть NULL пока карточка пустая)
  productName   String?   // Кэш названия товара
  state         String    @default("editing")  // editing / locked
  sortOrder     Int       @default(0)
  isDeleted     Boolean   @default(false)
  deletedAt     DateTime?
  deletedBy     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     String
  updatedBy     String?
  
  journal       ProductionJournal @relation(fields: [journalId], references: [id], onDelete: Cascade)
  product       Product?  @relation(fields: [productId], references: [id])
  values        ProductionItemValue[]
}

// Значения полей выработки (расширяемая таблица)
model ProductionItemValue {
  id                  Int       @id @default(autoincrement())
  productionItemId    Int       // FK -> ProductionItem
  fieldKey            String    // Ключ поля (qty, weight, etc.)
  fieldValue          String?   // Значение
  updatedAt           DateTime  @updatedAt
  updatedBy           String?
  
  productionItem      ProductionItem @relation(fields: [productionItemId], references: [id], onDelete: Cascade)
  
  @@unique([productionItemId, fieldKey])
}


// ============================================
// ПОДСИСТЕМА ПРАЙС-ЛИСТОВ
// ============================================

// Закупочный прайс - шапка документа (ЖУРНАЛ)
model PurchasePriceList {
  id          Int       @id @default(autoincrement())
  date        DateTime  // Общая дата прайса / дата вступления в силу
  name        String?   // Название/комментарий (опционально)
  isActive    Boolean   @default(true)   // Статус (true=активный, false=отключен)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String
  updatedBy   String?
  
  suppliers   PurchasePriceListSupplier[]
  items       PurchasePriceItem[]
  
  @@index([date])
  @@index([isActive, date])
}

// Связь прайса и поставщика (многие-ко-многим)
// При сохранении фиксируется первичный MML поставщика на момент создания
model PurchasePriceListSupplier {
  id            Int       @id @default(autoincrement())
  priceListId   Int       // FK -> PurchasePriceList
  supplierId    Int       // FK -> Supplier
  primaryMmlId  Int?      // FK -> ProductionMml (зафиксированный первичный MML на момент создания прайса)
  createdAt     DateTime  @default(now())
  
  priceList     PurchasePriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  supplier      Supplier  @relation(fields: [supplierId], references: [id])
  primaryMml    ProductionMml?    @relation("PriceListSupplierMml", fields: [primaryMmlId], references: [id])
  
  @@unique([priceListId, supplierId])
  @@index([supplierId])
  @@index([primaryMmlId])
}

// Закупочный прайс - строки (товары по поставщикам)
model PurchasePriceItem {
  id            Int       @id @default(autoincrement())
  priceListId   Int       // FK -> PurchasePriceList
  supplierId    Int       // FK -> Supplier
  productId     Int       // FK -> Product
  purchasePrice Decimal   @db.Decimal(14, 2)  // Закупочная цена
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  priceList     PurchasePriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  supplier      Supplier  @relation(fields: [supplierId], references: [id])
  product       Product   @relation(fields: [productId], references: [id])
  
  @@unique([priceListId, supplierId, productId])
  @@index([productId])
  @@index([supplierId])
}

// Продажный прайс - шапка документа
model SalesPriceList {
  id            Int       @id @default(autoincrement())
  listType      String    // GENERAL / CUSTOMER
  customerId    Int?      // FK -> Customer (только для CUSTOMER)
  title         String?   // Название/комментарий
  effectiveDate DateTime  // Дата вступления в силу (обязательная)
  status        String    @default("draft")  // draft / saved / archived
  isCurrent     Boolean   @default(false)    // Текущий активный прайс
  isHidden      Boolean   @default(false)    // Скрыт в журнале
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     String
  updatedBy     String?
  
  customer    Customer? @relation(fields: [customerId], references: [id])
  items       SalesPriceItem[]
  
  @@index([listType, isCurrent])
  @@index([customerId, createdAt])
  @@index([effectiveDate])
  @@index([isHidden, listType])
}

// Продажный прайс - строки
model SalesPriceItem {
  id          Int       @id @default(autoincrement())
  priceListId Int       // FK -> SalesPriceList
  productId   Int       // FK -> Product
  salePrice   Decimal   @db.Decimal(14, 2)  // Цена продажи
  rowDate     DateTime  @default(now())     // Дата строки
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  updatedBy   String?
  
  priceList   SalesPriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  product     Product   @relation(fields: [productId], references: [id])
  
  @@unique([priceListId, productId])
  @@index([productId])
  @@index([rowDate])
}

// ========== PRODUCTION MODULE (v2 - Tree Structure) ==========

// MML (калькуляция/техкарта) - шапка документа
// Один MML на один товар (productId уникален)
model ProductionMml {
  id          Int       @id @default(autoincrement())
  productId   Int       @unique  // Товар, для которого создан MML
  createdBy   Int       // User ID создателя
  isLocked    Boolean   @default(false)  // Зафиксирован (нельзя редактировать)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  product     Product   @relation(fields: [productId], references: [id])
  creator     User      @relation("MmlCreator", fields: [createdBy], references: [id])
  nodes       ProductionMmlNode[]  // Дерево узлов (корневые + подпозиции)
  runs        ProductionRun[]      // Выработки по этому MML
  
  // Обратные связи для первичного MML
  suppliersWithPrimaryMml   Supplier[]  @relation("SupplierPrimaryMml")
  priceListSuppliers        PurchasePriceListSupplier[]  @relation("PriceListSupplierMml")
  
  @@index([isLocked])
  @@index([createdAt])
}

// MML - узлы дерева (корневые позиции и подпозиции)
// parentNodeId = NULL → корневая позиция
// parentNodeId != NULL → подпозиция (дочерняя)
model ProductionMmlNode {
  id            Int       @id @default(autoincrement())
  mmlId         Int       // FK → ProductionMml
  parentNodeId  Int?      // FK → ProductionMmlNode (NULL = корень)
  productId     Int       // FK → Product (товар узла)
  sortOrder     Int       @default(0)  // Порядок отображения
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  mml           ProductionMml     @relation(fields: [mmlId], references: [id], onDelete: Cascade)
  parentNode    ProductionMmlNode?  @relation("NodeChildren", fields: [parentNodeId], references: [id], onDelete: Cascade)
  children      ProductionMmlNode[] @relation("NodeChildren")
  product       Product   @relation("MmlNodeProduct", fields: [productId], references: [id])
  runValues     ProductionRunValue[]  // Значения в выработках
  
  @@index([mmlId])
  @@index([parentNodeId])
  @@index([productId])
  @@index([mmlId, parentNodeId, sortOrder])
}

// Выработка (документ журнала производства)
// Заменяет старый ProductionBatch
model ProductionRun {
  id          Int       @id @default(autoincrement())
  productId   Int       // Что вырабатывается (основной товар)
  mmlId       Int       // Какой MML применён
  userId      Int       // Кто сделал выработку
  isLocked    Boolean   @default(false)  // Зафиксировано (нельзя редактировать)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  product     Product   @relation("ProductRuns", fields: [productId], references: [id])
  mml         ProductionMml @relation(fields: [mmlId], references: [id])
  user        User      @relation("RunUser", fields: [userId], references: [id])
  values      ProductionRunValue[]  // Значения по узлам
  
  @@index([productId])
  @@index([mmlId])
  @@index([userId])
  @@index([isLocked])
  @@index([createdAt])
}

// Значения выработки по узлам MML
// Каждый узел дерева имеет одно числовое значение в документе выработки
model ProductionRunValue {
  id              Int       @id @default(autoincrement())
  productionRunId Int       // FK → ProductionRun
  mmlNodeId       Int       // FK → ProductionMmlNode
  value           Decimal?  @db.Decimal(14, 3)  // Числовое значение (ввод пользователя)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  run             ProductionRun     @relation(fields: [productionRunId], references: [id], onDelete: Cascade)
  node            ProductionMmlNode @relation(fields: [mmlNodeId], references: [id])
  
  @@unique([productionRunId, mmlNodeId])  // Один узел = одно значение в документе
  @@index([productionRunId])
  @@index([mmlNodeId])
}

