<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ñ—É—Ä–Ω–∞–ª –∑–∞–∫—É–ø–æ–∫</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-header">ERP System</div>
        <nav class="sidebar-nav" id="sidebar-nav"></nav>
    </aside>
    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h1 class="page-title">–ñ—É—Ä–Ω–∞–ª <span class="accent">–∑–∞–∫—É–ø–æ–∫</span></h1>
            </div>
            <div class="card"
                style="padding:1rem;margin-bottom:1rem;display:flex;gap:1rem;align-items:center;flex-wrap:wrap;">
                <label>–°: <input type="date" id="filter-from"
                        style="margin-left:.3rem;padding:.4rem;border-radius:6px;background:var(--bg-primary);color:var(--text-primary);border:1px solid var(--border);"></label>
                <label>–ü–æ: <input type="date" id="filter-to"
                        style="margin-left:.3rem;padding:.4rem;border-radius:6px;background:var(--bg-primary);color:var(--text-primary);border:1px solid var(--border);"></label>
                <button id="btn-filter" class="btn btn-primary">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
                <button id="btn-delete-selected" class="btn btn-danger" disabled>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                <button id="btn-export" class="btn btn-success">üì§ Excel</button>
            </div>
            <div class="card">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th class="col-checkbox"><input type="checkbox" id="select-all"></th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                                <th>–ü–æ–∑–∏—Ü–∏–π</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–ü—Ä–æ—Å–º–æ—Ç—Ä</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
                <div id="empty-state" class="empty-state" style="display:none;">
                    <div class="empty-state-icon">üìñ</div>
                    <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                </div>
            </div>
        </div>
        <div class="container" id="detail-view" style="display:none;">
            <div class="page-header">
                <h1 class="page-title" id="detail-title">–î–µ—Ç–∞–ª–∏</h1><button id="btn-back" class="btn btn-secondary">‚Üê
                    –ù–∞–∑–∞–¥</button>
            </div>
            <div class="card">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>–¢–æ–≤–∞—Ä</th>
                                <th>–û–ø–ª–∞—Ç–∞</th>
                                <th>–ö–æ–ª-–≤–æ</th>
                                <th>–¶–µ–Ω–∞</th>
                                <th>–°—É–º–º–∞</th>
                            </tr>
                        </thead>
                        <tbody id="detail-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    <div id="toast" class="toast" style="display:none;"></div>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="storage.js"></script>
    <script src="sidebar.js"></script>
    <script>
        (function () {
            const mainView = document.querySelector('.container'), detailView = document.getElementById('detail-view'), tableBody = document.getElementById('table-body'), detailBody = document.getElementById('detail-body'), detailTitle = document.getElementById('detail-title'), emptyState = document.getElementById('empty-state'), selectAll = document.getElementById('select-all'), btnDelete = document.getElementById('btn-delete-selected'), btnFilter = document.getElementById('btn-filter'), btnExport = document.getElementById('btn-export'), btnBack = document.getElementById('btn-back'), filterFrom = document.getElementById('filter-from'), filterTo = document.getElementById('filter-to'), toast = document.getElementById('toast');
            function esc(s) { return s ? String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]): ''}
            function showToast(msg, type) { toast.textContent = msg; toast.className = 'toast ' + type; toast.style.display = 'block'; setTimeout(() => toast.style.display = 'none', 3000) }
            function getJournal() { return JSON.parse(localStorage.getItem('erp_journal_purchases') || '[]') }
            function saveJournal(j) { localStorage.setItem('erp_journal_purchases', JSON.stringify(j)) }

            function render() {
                let journal = getJournal();
                const from = filterFrom.value, to = filterTo.value;
                if (from) journal = journal.filter(j => j.date >= from);
                if (to) journal = journal.filter(j => j.date <= to);
                journal.sort((a, b) => b.date.localeCompare(a.date));
                tableBody.innerHTML = ''; emptyState.style.display = journal.length === 0 ? 'block' : 'none';
                journal.forEach((j, i) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="col-checkbox"><input type="checkbox" class="row-cb" data-idx="${i}" data-date="${j.date}" data-sid="${j.supplier_id}"></td><td>${esc(j.date)}</td><td>${esc(j.supplier_name)}</td><td>${j.rows?.length || 0}</td><td>${(j.total_sum || 0).toFixed(2)}</td><td><button class="btn btn-primary btn-sm" onclick="viewDetail('${j.date}','${j.supplier_id}')">üëÅÔ∏è</button></td>`;
                    tableBody.appendChild(tr);
                });
                updateBtn();
            }

            function updateBtn() { btnDelete.disabled = document.querySelectorAll('.row-cb:checked').length === 0 }
            selectAll.addEventListener('change', function () { document.querySelectorAll('.row-cb').forEach(cb => cb.checked = this.checked); updateBtn() });
            tableBody.addEventListener('change', e => { if (e.target.classList.contains('row-cb')) updateBtn() });
            btnFilter.addEventListener('click', render);

            btnDelete.addEventListener('click', function () {
                const toDelete = Array.from(document.querySelectorAll('.row-cb:checked')).map(cb => ({ date: cb.dataset.date, sid: cb.dataset.sid }));
                let journal = getJournal();
                journal = journal.filter(j => !toDelete.some(d => d.date === j.date && d.sid === j.supplier_id));
                saveJournal(journal);
                selectAll.checked = false;
                render();
                showToast('–£–¥–∞–ª–µ–Ω–æ', 'success');
            });

            window.viewDetail = function (date, sid) {
                const j = getJournal().find(x => x.date === date && x.supplier_id === sid);
                if (!j) { showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', 'error'); return }
                detailTitle.textContent = `–ó–∞–∫—É–ø–∫–∏: ${j.supplier_name} (${date})`;
                detailBody.innerHTML = '';
                (j.rows || []).forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${esc(r.product_name)}</td><td>${esc(r.payment_type)}</td><td>${r.qty}</td><td>${r.price}</td><td>${(r.sum || 0).toFixed(2)}</td>`;
                    detailBody.appendChild(tr);
                });
                mainView.style.display = 'none';
                detailView.style.display = 'block';
            };

            btnBack.addEventListener('click', () => { detailView.style.display = 'none'; mainView.style.display = 'block' });

            btnExport.addEventListener('click', function () {
                const journal = getJournal();
                const data = [];
                journal.forEach(j => {
                    (j.rows || []).forEach(r => {
                        data.push({ '–î–∞—Ç–∞': j.date, '–ü–æ—Å—Ç–∞–≤—â–∏–∫': j.supplier_name, '–¢–æ–≤–∞—Ä': r.product_name, '–û–ø–ª–∞—Ç–∞': r.payment_type, '–ö–æ–ª-–≤–æ': r.qty, '–¶–µ–Ω–∞': r.price, '–°—É–º–º–∞': r.sum });
                    });
                });
                const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, '–ó–∞–∫—É–ø–∫–∏'); XLSX.writeFile(wb, 'journal_purchases.xlsx'); showToast('–≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤', 'success');
            });

            render();
        })();
    </script>
</body>

</html>