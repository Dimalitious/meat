<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-header">ERP System</div>
        <nav class="sidebar-nav" id="sidebar-nav"></nav>
    </aside>
    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h1 class="page-title">üì¶ –ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–π <span class="accent">–æ—Ç—á—ë—Ç</span></h1>
            </div>
            <div class="card"
                style="padding:1rem;margin-bottom:1rem;display:flex;gap:1rem;align-items:center;flex-wrap:wrap;">
                <label>–°: <input type="date" id="filter-from"
                        style="margin-left:.3rem;padding:.4rem;border-radius:6px;background:var(--bg-primary);color:var(--text-primary);border:1px solid var(--border);"></label>
                <label>–ü–æ: <input type="date" id="filter-to"
                        style="margin-left:.3rem;padding:.4rem;border-radius:6px;background:var(--bg-primary);color:var(--text-primary);border:1px solid var(--border);"></label>
                <select id="filter-product"
                    style="padding:.4rem;border-radius:6px;background:var(--bg-primary);color:var(--text-primary);border:1px solid var(--border);min-width:200px;">
                    <option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
                </select>
                <button id="btn-generate" class="btn btn-primary">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
                <button id="btn-export" class="btn btn-success">üì§ Excel</button>
            </div>
            <div class="card" style="margin-bottom:1rem;">
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;padding:1rem;">
                    <div class="stat-card">
                        <div class="stat-label">–ù–∞—á–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫</div>
                        <div class="stat-value" id="stat-opening">0.0 –∫–≥</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ü—Ä–∏—Ö–æ–¥</div>
                        <div class="stat-value" id="stat-incoming" style="color:var(--success);">+0.0 –∫–≥</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–†–∞—Å—Ö–æ–¥</div>
                        <div class="stat-value" id="stat-outgoing" style="color:var(--danger);">-0.0 –∫–≥</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ö–æ–Ω–µ—á–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫</div>
                        <div class="stat-value" id="stat-closing">0.0 –∫–≥</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–û–ø–µ—Ä–∞—Ü–∏—è</th>
                                <th>–¢–æ–≤–∞—Ä</th>
                                <th>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</th>
                                <th>–ü—Ä–∏—Ö–æ–¥</th>
                                <th>–†–∞—Å—Ö–æ–¥</th>
                                <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
                <div id="empty-state" class="empty-state" style="display:none;">
                    <div class="empty-state-icon">üì¶</div>
                    <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
                </div>
            </div>
        </div>
    </main>
    <div id="toast" class="toast" style="display:none;"></div>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="storage.js"></script>
    <script src="sidebar.js"></script>
    <script>
        (function () {
            const tableBody = document.getElementById('table-body'), emptyState = document.getElementById('empty-state'), btnGenerate = document.getElementById('btn-generate'), btnExport = document.getElementById('btn-export'), filterFrom = document.getElementById('filter-from'), filterTo = document.getElementById('filter-to'), filterProduct = document.getElementById('filter-product'), statOpening = document.getElementById('stat-opening'), statIncoming = document.getElementById('stat-incoming'), statOutgoing = document.getElementById('stat-outgoing'), statClosing = document.getElementById('stat-closing'), toast = document.getElementById('toast');

            let reportData = [];

            function esc(s) { return s ? String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])) : '' }
            function showToast(msg, type) { toast.textContent = msg; toast.className = 'toast ' + type; toast.style.display = 'block'; setTimeout(() => toast.style.display = 'none', 3000) }

            // Populate products filter
            function loadProducts() {
                const products = StorageService.getProducts();
                filterProduct.innerHTML = '<option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>';
                products.forEach(p => {
                    filterProduct.innerHTML += `<option value="${esc(p.product_code)}">${esc(p.product_name)}</option>`;
                });
            }

            function generateReport() {
                const from = filterFrom.value, to = filterTo.value, productCode = filterProduct.value;
                reportData = [];
                let runningBalance = 0;
                let totalIncoming = 0, totalOutgoing = 0;

                // Get purchases (incoming)
                const purchases = StorageService.getJournalPurchases();
                purchases.forEach(p => {
                    if (from && p.date < from) return;
                    if (to && p.date > to) return;
                    (p.rows || []).forEach(r => {
                        if (productCode && r.product_code !== productCode) return;
                        const qty = parseFloat(r.quantity) || 0;
                        reportData.push({
                            date: p.date,
                            operation: '–ó–∞–∫—É–ø–∫–∞',
                            product: r.product_name || r.product_code,
                            counterparty: p.supplier_name,
                            incoming: qty,
                            outgoing: 0
                        });
                    });
                });

                // Get shipments (outgoing)
                const shipments = StorageService.getJournalShipments();
                shipments.forEach(s => {
                    if (from && s.date < from) return;
                    if (to && s.date > to) return;
                    (s.shipments || []).forEach(r => {
                        if (productCode) {
                            const product = StorageService.getProductByCode(r.product_code);
                            if (!product || product.product_code !== productCode) return;
                        }
                        const qty = parseFloat(r.shipped_fact) || 0;
                        const product = StorageService.getProductByCode(r.product_code);
                        const customer = StorageService.getCustomers().find(c => String(c.customer_id) === String(r.customer_id));
                        reportData.push({
                            date: s.date,
                            operation: '–û—Ç–≥—Ä—É–∑–∫–∞',
                            product: product?.product_name || r.product_code,
                            counterparty: customer?.customer_name || r.customer_id,
                            incoming: 0,
                            outgoing: qty
                        });
                    });
                });

                // Sort by date
                reportData.sort((a, b) => a.date.localeCompare(b.date));

                // Calculate running balance
                reportData.forEach(r => {
                    runningBalance += r.incoming - r.outgoing;
                    r.balance = runningBalance;
                    totalIncoming += r.incoming;
                    totalOutgoing += r.outgoing;
                });

                // Update stats
                statOpening.textContent = '0.0 –∫–≥';
                statIncoming.textContent = `+${totalIncoming.toFixed(1)} –∫–≥`;
                statOutgoing.textContent = `-${totalOutgoing.toFixed(1)} –∫–≥`;
                statClosing.textContent = `${runningBalance.toFixed(1)} –∫–≥`;

                // Render table
                tableBody.innerHTML = '';
                emptyState.style.display = reportData.length === 0 ? 'block' : 'none';
                reportData.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${esc(r.date)}</td><td>${esc(r.operation)}</td><td>${esc(r.product)}</td><td>${esc(r.counterparty)}</td><td style="color:var(--success);">${r.incoming > 0 ? '+' + r.incoming.toFixed(1) : ''}</td><td style="color:var(--danger);">${r.outgoing > 0 ? '-' + r.outgoing.toFixed(1) : ''}</td><td>${r.balance.toFixed(1)}</td>`;
                    tableBody.appendChild(tr);
                });
            }

            btnGenerate.addEventListener('click', generateReport);

            btnExport.addEventListener('click', function () {
                if (reportData.length === 0) { showToast('–°–Ω–∞—á–∞–ª–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç', 'error'); return; }
                const data = reportData.map(r => ({
                    '–î–∞—Ç–∞': r.date,
                    '–û–ø–µ—Ä–∞—Ü–∏—è': r.operation,
                    '–¢–æ–≤–∞—Ä': r.product,
                    '–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç': r.counterparty,
                    '–ü—Ä–∏—Ö–æ–¥': r.incoming || '',
                    '–†–∞—Å—Ö–æ–¥': r.outgoing || '',
                    '–û—Å—Ç–∞—Ç–æ–∫': r.balance
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '–ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç');
                XLSX.writeFile(wb, 'material_report.xlsx');
                showToast('–≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤', 'success');
            });

            loadProducts();
        })();
    </script>
</body>

</html>