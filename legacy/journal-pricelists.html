<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ñ—É—Ä–Ω–∞–ª –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–æ–≤</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-header">ERP System</div>
        <nav class="sidebar-nav" id="sidebar-nav"></nav>
    </aside>
    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h1 class="page-title">–ñ—É—Ä–Ω–∞–ª <span class="accent">–ø—Ä–∞–π—Å-–ª–∏—Å—Ç–æ–≤</span></h1>
            </div>
            <div class="card"
                style="padding:1rem;margin-bottom:1rem;display:flex;gap:1rem;align-items:center;flex-wrap:wrap;">
                <label>–°: <input type="date" id="filter-from"
                        style="margin-left:.3rem;padding:.4rem;border-radius:6px;background:var(--bg-primary);color:var(--text-primary);border:1px solid var(--border);"></label>
                <label>–ü–æ: <input type="date" id="filter-to"
                        style="margin-left:.3rem;padding:.4rem;border-radius:6px;background:var(--bg-primary);color:var(--text-primary);border:1px solid var(--border);"></label>
                <button id="btn-filter" class="btn btn-primary">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
                <button id="btn-delete-selected" class="btn btn-danger" disabled>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                <button id="btn-export" class="btn btn-success">üì§ Excel</button>
            </div>
            <div class="card">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th class="col-checkbox"><input type="checkbox" id="select-all"></th>
                                <th>–î–∞—Ç–∞ –ø—Ä–∞–π—Å–∞</th>
                                <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                                <th>–ü–æ–∑–∏—Ü–∏–π</th>
                                <th>–°–æ–∑–¥–∞–Ω</th>
                                <th>–ü—Ä–æ—Å–º–æ—Ç—Ä</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
                <div id="empty-state" class="empty-state" style="display:none;">
                    <div class="empty-state-icon">üí∞</div>
                    <p>–ù–µ—Ç –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–æ–≤</p>
                </div>
            </div>
        </div>
        <div class="container" id="detail-view" style="display:none;">
            <div class="page-header">
                <h1 class="page-title" id="detail-title">–î–µ—Ç–∞–ª–∏</h1><button id="btn-back" class="btn btn-secondary">‚Üê
                    –ù–∞–∑–∞–¥</button>
            </div>
            <div class="card">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞</th>
                                <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                                <th>–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏</th>
                            </tr>
                        </thead>
                        <tbody id="detail-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    <div id="toast" class="toast" style="display:none;"></div>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="storage.js"></script>
    <script src="sidebar.js"></script>
    <script>
        (function () {
            const mainView = document.querySelector('.container'), detailView = document.getElementById('detail-view'), tableBody = document.getElementById('table-body'), detailBody = document.getElementById('detail-body'), detailTitle = document.getElementById('detail-title'), emptyState = document.getElementById('empty-state'), selectAll = document.getElementById('select-all'), btnDelete = document.getElementById('btn-delete-selected'), btnFilter = document.getElementById('btn-filter'), btnExport = document.getElementById('btn-export'), btnBack = document.getElementById('btn-back'), filterFrom = document.getElementById('filter-from'), filterTo = document.getElementById('filter-to'), toast = document.getElementById('toast');

            function esc(s) { return s ? String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])) : '' }
            function showToast(msg, type) { toast.textContent = msg; toast.className = 'toast ' + type; toast.style.display = 'block'; setTimeout(() => toast.style.display = 'none', 3000) }

            function render() {
                let journal = StorageService.getJournalPricelists();
                const from = filterFrom.value, to = filterTo.value;
                if (from) journal = journal.filter(j => j.date >= from);
                if (to) journal = journal.filter(j => j.date <= to);
                journal.sort((a, b) => b.date.localeCompare(a.date) || b.created_at.localeCompare(a.created_at));
                tableBody.innerHTML = ''; emptyState.style.display = journal.length === 0 ? 'block' : 'none';
                journal.forEach(j => {
                    const tr = document.createElement('tr');
                    const createdDate = j.created_at ? new Date(j.created_at).toLocaleString('ru') : '-';
                    tr.innerHTML = `<td class="col-checkbox"><input type="checkbox" class="row-cb" data-id="${j.id}"></td><td>${esc(j.date)}</td><td>${esc(j.supplier_name)}</td><td>${j.total_items || 0}</td><td>${createdDate}</td><td><button class="btn btn-primary btn-sm" onclick="viewDetail(${j.id})">üëÅÔ∏è</button></td>`;
                    tableBody.appendChild(tr);
                });
                updateBtn();
            }

            function updateBtn() { btnDelete.disabled = document.querySelectorAll('.row-cb:checked').length === 0 }
            selectAll.addEventListener('change', function () { document.querySelectorAll('.row-cb').forEach(cb => cb.checked = this.checked); updateBtn() });
            tableBody.addEventListener('change', e => { if (e.target.classList.contains('row-cb')) updateBtn() });
            btnFilter.addEventListener('click', render);

            btnDelete.addEventListener('click', function () {
                const ids = Array.from(document.querySelectorAll('.row-cb:checked')).map(cb => parseInt(cb.dataset.id));
                StorageService.deleteJournalPricelistsByIds(ids);
                selectAll.checked = false;
                render();
                showToast('–£–¥–∞–ª–µ–Ω–æ', 'success');
            });

            window.viewDetail = function (id) {
                const j = StorageService.getJournalPricelists().find(x => x.id === id);
                if (!j) { showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', 'error'); return }
                detailTitle.textContent = `–ü—Ä–∞–π—Å-–ª–∏—Å—Ç: ${j.supplier_name} (${j.date})`;
                detailBody.innerHTML = '';
                (j.prices || []).forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${esc(r.product_code)}</td><td>${esc(r.product_name)}</td><td>${parseFloat(r.price || 0).toFixed(2)}</td>`;
                    detailBody.appendChild(tr);
                });
                mainView.style.display = 'none';
                detailView.style.display = 'block';
            };

            btnBack.addEventListener('click', () => { detailView.style.display = 'none'; mainView.style.display = 'block' });

            btnExport.addEventListener('click', function () {
                const journal = StorageService.getJournalPricelists();
                const data = [];
                journal.forEach(j => {
                    (j.prices || []).forEach(r => {
                        data.push({ '–î–∞—Ç–∞ –ø—Ä–∞–π—Å–∞': j.date, '–ü–æ—Å—Ç–∞–≤—â–∏–∫': j.supplier_name, '–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞': r.product_code, '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ': r.product_name, '–¶–µ–Ω–∞': r.price });
                    });
                });
                const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, '–ü—Ä–∞–π—Å-–ª–∏—Å—Ç—ã'); XLSX.writeFile(wb, 'journal_pricelists.xlsx'); showToast('–≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤', 'success');
            });

            render();
        })();
    </script>
</body>

</html>