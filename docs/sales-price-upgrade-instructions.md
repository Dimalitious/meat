# Модернизация формы «Продажный прайс» — Инструкция по развёртыванию

## Обзор изменений

Согласно ТЗ, модуль «Продажный прайс» модернизирован и включает:

### 1. База данных (SalesPriceList)
Добавлены новые поля:
- `effectiveDate` — Дата вступления в силу прайса (обязательное поле)
- `isHidden` — Флаг скрытия из журнала (для кнопки "Скрыть прайсы")

### 2. Журнал продажных прайсов
- Фильтрация по периоду (дата «С» / «По»)
- Таблица с чекбоксами для выбора
- Кнопка «Скрыть прайсы» — скрывает выбранные записи
- Кнопка «Добавить прайс-лист» — открывает форму создания
- Новая колонка «Дата вступления в силу»

### 3. Форма создания/редактирования прайс-листа
- **Два таба:**
  - «Общий прайс» (по умолчанию для всех заказчиков)
  - «По заказчику» (персональный прайс с приоритетом)
- **Общая дата вступления в силу** в верхней панели
- Таблица товаров с 3 колонками:
  - Наименование товара (из поля `priceListName`)
  - Цена
  - Дата создания записи
- Валидация перед сохранением

### 4. Логика приоритетов цен
**Важное изменение:** Если у заказчика есть персональный прайс (активный по дате), общий прайс **полностью игнорируется**, даже для товаров, которых нет в персональном прайсе.

---

## Шаги для развёртывания

### Шаг 1: Применить миграцию БД

**Вариант A: Через Prisma (рекомендуется)**
```bash
cd d:\meatpr\meat\server
npx prisma migrate dev --name add_sales_price_effective_date_and_hidden
```

**Вариант B: Ручной SQL (если миграция не работает)**
Выполнить SQL из файла:
`server/prisma/migrations/manual/add_sales_price_effective_date_and_hidden.sql`

### Шаг 2: Сгенерировать Prisma Client
```bash
cd d:\meatpr\meat\server
npx prisma generate
```

### Шаг 3: Перезапустить сервер
```bash
cd d:\meatpr\meat\server
npm run dev
```

### Шаг 4: Перезапустить клиент
```bash
cd d:\meatpr\meat\client
npm run dev
```

---

## API изменения

### Новые/обновлённые эндпоинты

| Метод | Эндпоинт | Описание |
|-------|----------|----------|
| GET | `/api/prices/sales` | Добавлен параметр `showHidden`. Фильтрация по `effectiveDate` |
| POST | `/api/prices/sales` | Обязательный параметр `effectiveDate` |
| PUT | `/api/prices/sales/:id` | Опциональный параметр `effectiveDate` |
| POST | `/api/prices/sales/hide` | **НОВЫЙ** — Скрыть выбранные прайсы `{ ids: number[] }` |

---

## Навигация

- **Меню "Прайсы" → "Продажный прайс"** — открывает журнал
- **В журнале кнопка "Добавить прайс-лист"** — открывает форму создания

---

## Проверка работоспособности

1. Открыть журнал продажных прайсов
2. Убедиться, что отображаются существующие записи (если есть)
3. Нажать «Добавить прайс-лист»
4. Выбрать тип (Общий / По заказчику)
5. Указать дату вступления в силу
6. Добавить товары и цены
7. Сохранить
8. Проверить, что запись появилась в журнале
9. Выбрать запись чекбоксом и нажать «Скрыть» — запись должна исчезнуть из списка

---

## Файлы изменений

### Сервер
- `server/prisma/schema.prisma` — обновлена модель SalesPriceList
- `server/src/controllers/prices.controller.ts` — обновлена логика
- `server/src/routes/prices.routes.ts` — добавлен маршрут для скрытия

### Клиент
- `client/src/pages/SalesPriceJournalPage.tsx` — переработан журнал
- `client/src/pages/SalesPricePage.tsx` — переработана форма
- `client/src/components/Layout.tsx` — обновлена навигация
