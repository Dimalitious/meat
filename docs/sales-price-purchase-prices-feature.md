# Доработка: Отображение закупочных цен поставщиков в форме продажного прайса

## Дата реализации
21.01.2026

## Описание функционала

При создании/редактировании продажного прайс-листа (в обоих табах: "Общий прайс" и "По заказчику") система теперь отображает закупочные цены всех поставщиков по каждому товару.

### Как это работает

1. **Кнопка раскрытия** — слева от каждой строки товара появилась кнопка ▼/▲
2. **При клике** — раскрывается блок "Закупочные цены поставщиков"
3. **Данные** — система показывает все закупочные цены по товару, где:
   - Поставщик активен (не отключён)
   - Закупочный прайс активен (не отключён)
   - Дата закупочного прайса ≤ дата вступления в силу продажного прайса
4. **По каждому поставщику** — берётся только последняя (самая свежая) закупочная цена

### Отображаемые данные

| Поле | Описание |
|------|----------|
| Поставщик | Название поставщика (+ юридическое название если есть) |
| Закупочная цена | Цена закупки в тенге |
| Дата прайса | Дата закупочного прайса, из которого взята цена |

### Динамическое обновление

- При изменении **даты вступления в силу** продажного прайса — закупочные цены пересчитываются автоматически (кеш сбрасывается)
- Закупочные цены загружаются **лениво** — только при раскрытии строки товара

---

## Технические детали

### Backend

**Новый API endpoint:**
```
GET /api/prices/purchase/product-prices?productId={id}&targetDate={date}
```

**Параметры:**
- `productId` (number) — ID товара
- `targetDate` (string, ISO date) — дата, до которой искать закупочные цены

**Ответ:**
```json
{
  "productId": 123,
  "targetDate": "2026-01-21T23:59:59.999Z",
  "supplierPrices": [
    {
      "supplierId": 1,
      "supplierName": "Поставщик 1",
      "supplierLegalName": "ТОО Поставщик",
      "purchasePrice": 1500.00,
      "priceListDate": "2026-01-15T00:00:00.000Z",
      "priceListId": 5,
      "priceListName": "Январь 2026"
    }
  ],
  "count": 1
}
```

**Файлы:**
- `server/src/controllers/prices.controller.ts` — функция `getPurchasePricesForProduct`
- `server/src/routes/prices.routes.ts` — маршрут `/purchase/product-prices`

### Frontend

**Файл:** `client/src/pages/SalesPricePage.tsx`

**Новые состояния:**
```typescript
const [expandedProductId, setExpandedProductId] = useState<number | null>(null);
const [supplierPrices, setSupplierPrices] = useState<Map<number, SupplierPrice[]>>(new Map());
const [loadingPrices, setLoadingPrices] = useState<Set<number>>(new Set());
```

**Новые функции:**
- `fetchSupplierPrices(productId)` — загрузка закупочных цен для товара
- `toggleExpand(productId)` — переключение раскрытия строки

---

## Развёртывание

1. **Обновить Prisma клиент** (если были изменения в схеме):
   ```bash
   cd server
   npx prisma generate
   ```

2. **Перезапустить сервер**:
   ```bash
   cd server
   npm run dev
   ```

3. **Перезапустить клиент**:
   ```bash
   cd client
   npm run dev
   ```

---

## Приёмочное тестирование

| Сценарий | Ожидаемый результат |
|----------|---------------------|
| Создать новый продажный прайс, добавить товар, нажать ▼ | Открывается блок с закупочными ценами |
| Товар есть в закупочных прайсах | Отображаются поставщики с ценами |
| Товара нет в закупочных прайсах | Сообщение "Нет закупочных цен..." |
| Изменить дату вступления в силу | Закупочные цены пересчитываются |
| Таб "По заказчику" | Работает аналогично |

---

## Ограничения

- Закупочные цены НЕ сохраняются как снимок (пересчитываются при каждом просмотре)
- Для реализации снимков понадобится создать таблицу `SalesPricePurchaseSnapshot` (см. ТЗ)
