# Переделка формы «Заказы» в формат «Журнал заказов» — Инструкция по развёртыванию

## Обзор изменений

Согласно ТЗ, форма «Заказы» модернизирована в формат «Журнал заказов» с возможностью массового отключения:

### 1. База данных (Order)
Добавлено новое поле:
- `isDisabled` (Boolean, default: false) — Отключенный заказ (soft-disable)

Добавлены индексы:
- `Order_date_idx` — для фильтрации по дате
- `Order_isDisabled_idx` — для фильтрации активных заказов
- `Order_isDisabled_date_idx` — составной индекс для оптимизации журнала

### 2. Журнал заказов (новый главный экран)
- **Фильтр периода**: Поля даты «С» / «По» с кнопкой «Сформировать»
- **Кнопка «Новый заказ»**: Создание нового заказа (логика сохранена)
- **Чекбоксы**: Выбор одного или нескольких заказов
- **Кнопка «Выключить выбранные»**: Массовое отключение заказов (soft-disable)
- **Таблица**: Отображает все колонки + действия (Просмотр, Редактирование, Печать)

### 3. Логика отключения заказов
- «Выключить» = soft-disable, заказ остается в БД
- Отключенные заказы не отображаются в журнале по умолчанию
- Все связи и расчёты сохраняются

### 4. Что НЕ изменено
- Состав заказа (товары, количества, цены)
- Логика создания/редактирования заказа
- Привязки к клиенту/менеджеру/району
- Печать, отгрузки, свод, сборки
- Вычисления и формулы

---

## Шаги для развёртывания

### Шаг 1: Применить миграцию БД

**Вариант A: Через Prisma (рекомендуется)**
```bash
cd d:\meatpr\meat\server
npx prisma migrate dev --name add_order_disabled_field
```

**Вариант B: Ручной SQL**
Выполнить SQL из файла:
`server/prisma/migrations/manual/add_order_disabled_field.sql`

### Шаг 2: Сгенерировать Prisma Client
```bash
cd d:\meatpr\meat\server
npx prisma generate
```

### Шаг 3: Перезапустить сервер
```bash
cd d:\meatpr\meat\server
npm run dev
```

### Шаг 4: Перезапустить клиент
```bash
cd d:\meatpr\meat\client
npm run dev
```

---

## API изменения

### Обновлённые эндпоинты

| Метод | Эндпоинт | Описание |
|-------|----------|----------|
| GET | `/api/orders` | Добавлены параметры `dateFrom`, `dateTo`, `showDisabled`. По умолчанию отключенные заказы не возвращаются |
| POST | `/api/orders/disable` | **НОВЫЙ** — Массовое отключение `{ ids: number[] }` |

---

## Навигация

- **Меню "Журнал заказов"** — открывает журнал с фильтрами
- **Кнопка "Новый заказ"** в журнале → форма создания заказа

---

## Сценарии приёмки

1. ✅ Открыл «Заказы» → вижу журнал с фильтром С/По и «Сформировать»
2. ✅ Выбрал период → по кнопке «Сформировать» вижу только заказы в интервале
3. ✅ Нажал «Новый заказ» → создал → сохранил → заказ появился в журнале
4. ✅ Отметил 2–3 заказа чекбоксами → нажал «Выключить выбранные заказы» → подтвердил
5. ✅ Отмеченные заказы исчезли из списка
6. ✅ При повторном открытии журнала выключенные заказы по умолчанию не отображаются
7. ✅ Все остальные функции заказа работают как раньше

---

## Файлы изменений

### Сервер
- `server/prisma/schema.prisma` — добавлено поле `isDisabled` в модель Order
- `server/src/controllers/orders.controller.ts` — обновлён `getOrders`, добавлен `disableOrders`
- `server/src/routes/orders.routes.ts` — добавлен маршрут `/disable`

### Клиент
- `client/src/pages/OrdersPage.tsx` — полностью переработан в формат журнала
- `client/src/components/Layout.tsx` — переименован пункт меню на "Журнал заказов"
