# Telegram Agent - Инструкция по запуску

## Требования

1. **Node.js** 18+ установлен
2. **Telegram API credentials** с [my.telegram.org](https://my.telegram.org):
   - API ID
   - API Hash
3. **Телефонный номер** для авторизации (рекомендуется отдельный номер)

## Первоначальная настройка

### 1. Установка зависимостей

```bash
cd telegram-agent
npm install
```

### 2. Конфигурация

Скопируйте `.env.example` в `.env` и заполните:

```bash
cp .env.example .env
```

Отредактируйте `.env`:

```env
# Получите на https://my.telegram.org
TELEGRAM_API_ID=12345678
TELEGRAM_API_HASH=abcdef1234567890abcdef1234567890

# Номер телефона с кодом страны
TELEGRAM_PHONE=+77001234567

# URL вашего сервера meatpr
MEATPR_SERVER_URL=http://localhost:3001

# Секретный ключ (опционально)
MEATPR_API_KEY=your-secret-key
```

### 3. Получение API credentials

1. Перейдите на [my.telegram.org](https://my.telegram.org)
2. Войдите с номером телефона
3. Перейдите в "API development tools"
4. Создайте приложение (любое название)
5. Скопируйте `api_id` и `api_hash`

## Запуск

### Первый запуск (авторизация)

```bash
npm run dev
```

При первом запуске:
1. Введите код подтверждения из SMS/Telegram
2. Если включена 2FA — введите пароль
3. Сессия сохранится в `session/telegram.session`

### Последующие запуски

Просто:
```bash
npm run dev
```

Или для production:
```bash
npm run build
npm start
```

## Добавление групп для мониторинга

1. Войдите в систему Meat ERP
2. Перейдите в **Telegram заказы** в меню
3. Нажмите **"+"** в разделе "Группы мониторинга"
4. Введите:
   - **Chat ID** — ID группы (см. ниже как получить)
   - **Название** — для отображения в системе
   - **Username** — @username группы (если есть)

### Как получить Chat ID группы

1. Добавьте бота [@userinfobot](https://t.me/userinfobot) в группу
2. Бот покажет ID группы (обычно отрицательное число вида `-1001234567890`)
3. Или переслать сообщение из группы боту [@getidsbot](https://t.me/getidsbot)

## Формат заказов

Telegram Agent распознаёт заказы в формате:

```
Заказ #123
Говядина 10кг
Свинина 5кг
Доставка: ул. Ленина, 15
Клиент: Иванов
```

### Поддерживаемые паттерны:

- `Товар 10кг` или `Товар - 10 кг`
- `Заказ #123` или `№ 123`
- `Клиент: Название`
- `Доставка: Адрес`

## Структура проекта

```
telegram-agent/
├── src/
│   ├── index.ts      # Главный файл
│   ├── config.ts     # Конфигурация
│   ├── api.ts        # HTTP клиент к meatpr
│   └── parser.ts     # Парсер заказов
├── session/          # Сохранённая сессия Telegram
├── .env              # Конфигурация (не в git!)
├── .env.example      # Пример конфигурации
└── package.json
```

## Безопасность

⚠️ **Важно:**

1. **Не используйте личный номер** — используйте отдельный номер для бота
2. **Не делитесь session файлом** — это ваша авторизация
3. **Добавьте `.env` в `.gitignore`** — там ваши секреты
4. **Риск бана ~10%** — Telegram может заблокировать аккаунт при подозрительной активности

## Troubleshooting

### "PHONE_NUMBER_INVALID"
- Проверьте формат номера: `+77001234567`

### "SESSION_REVOKED"  
- Удалите `session/telegram.session` и авторизуйтесь заново

### "Cannot connect to server"
- Проверьте что meatpr сервер запущен
- Проверьте URL в `.env`

### Бот не видит сообщения
- Проверьте что аккаунт состоит в группе
- Проверьте что Chat ID указан правильно
- Проверьте что группа активна в настройках

## Остановка

- `Ctrl+C` для graceful shutdown
- `npm run stop` если запущен в фоне
